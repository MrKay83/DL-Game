<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Lord</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content display */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #2d3748; /* Slightly lighter dark background */
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(3, 1fr); /* Three columns for main layout */
            max-width: 1200px;
            width: 100%;
        }
        .panel {
            background-color: #4a5568; /* Even lighter dark background for panels */
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid #6b7280;
        }
        .panel-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #cbd5e0;
            border-bottom: 1px solid #718096;
            padding-bottom: 5px;
            cursor: grab; /* Indicate draggable area */
            position: relative; /* For absolute positioning of close button */
        }
        .table-container {
            max-height: 250px; /* Increased default height for scrollable tables */
            overflow-y: auto;
            border: 1px solid #718096;
            border-radius: 6px;
        }
        /* Specific height for market table to reduce scrolling */
        .market-panel .table-container {
            max-height: 400px; /* Increased height for market table */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #718096;
        }
        th {
            background-color: #2d3748;
            color: #a0aec0;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .btn {
            background-color: #4299e1; /* Blue */
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
            border: none;
        }
        .btn:hover {
            background-color: #3182ce; /* Darker blue */
        }
        .btn:disabled {
            background-color: #a0aec0; /* Grey */
            cursor: not-allowed;
        }
        .input-field {
            background-color: #2d3748;
            border: 1px solid #718096;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e2e8f0;
            width: 100%;
            box-sizing: border-box;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #718096;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: 600;
            color: #cbd5e0;
        }
        .status-value {
            color: #a0aec0;
        }
        .message-box {
            position: fixed;
            background-color: #2d3748;
            border: 2px solid #4299e1;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 900;
            display: none;
            flex-direction: column;
            align-items: center;
            max-width: 400px;
            width: 90%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            resize: both; /* Allow manual resize */
            overflow: auto; /* Ensure scrollbars if content overflows */
        }
        /* Default sizes for common modals */
        #message-box {
            z-index: 10000;
            min-width: 350px;
            min-height: 180px;
            max-width: 600px;
            max-height: 80vh;
        }
        #places-modal {
            min-width: 500px;
            min-height: 350px;
            max-width: 800px;
            max-height: 90vh;
        }
        /* UPDATED: Matches shopping-modal dimensions */
        #finances-modal {
            min-width: 550px;
            min-height: 450px;
            max-width: 950px;
            max-height: 90vh;
        }
        #shopping-modal {
            min-width: 550px;
            min-height: 450px;
            max-width: 950px;
            max-height: 90vh;
        }
        #hospital-modal {
            min-width: 450px;
            min-height: 350px;
            max-width: 650px;
            max-height: 80vh;
        }
        #vault-modal {
            min-width: 650px;
            min-height: 450px;
            max-width: 1050px;
            max-height: 90vh;
        }
        #shipping-modal {
            min-width: 750px;
            min-height: 550px;
            max-width: 1150px;
            max-height: 95vh;
        }
        #sell-drug-modal, #buy-drug-modal, #dump-drug-modal, #sell-item-modal, #buy-item-quantity-modal, #borrow-amount-modal {
            min-width: 400px;
            min-height: 250px;
            max-width: 650px;
            max-height: 80vh;
        }
        #info-options-modal {
            min-width: 350px;
            min-height: 220px;
            max-width: 550px;
            max-height: 80vh;
        }
        #world-prices-quantities-modal, #world-cities-modal {
            min-width: 750px;
            min-height: 450px;
            max-width: 1050px;
            max-height: 90vh;
        }
        #shipment-status-modal {
            min-width: 550px;
            min-height: 300px;
            max-width: 850px;
            max-height: 80vh;
        }
        #using-no-scent-modal {
            min-width: 450px;
            min-height: 300px;
            max-width: 750px;
            max-height: 80vh;
        }
        #airport-security-modal {
            min-width: 550px;
            min-height: 500px;
            max-width: 850px;
            max-height: 95vh;
        }

        /* Close button styling */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #cbd5e0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: #ef4444; /* Red on hover */
        }


        .message-box-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .message-box-actions button {
            margin: 0 10px;
        }

        .message-box-content {
            margin-bottom: 20px;
            text-align: center;
            color: #e2e8f0;
            white-space: pre-wrap;
        }
        .info-panel {
            grid-column: span 3;
        }
        .market-panel {
            grid-column: span 2;
        }
        .action-panel {
            grid-column: span 1;
        }
        .inventory-panel {
            grid-column: span 2;
        }
        .status-panel {
            grid-column: span 1;
        }
        .tomorrow-panel {
            grid-column: span 1;
        }
        .game-panel {
            grid-column: span 2;
        }

        .pointer-events-none {
            pointer-events: none;
            opacity: 0.5;
        }

        .rumor-text {
            font-weight: bold;
            color: #ef4444; /* Red color for rumors */
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .game-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .info-panel, .market-panel, .inventory-panel, .game-panel {
                grid-column: span 2;
            }
            .action-panel, .status-panel, .tomorrow-panel {
                grid-column: span 1;
            }
            /* Adjust modal sizes for smaller screens if needed */
            .message-box {
                max-width: 95vw;
                max-height: 95vh;
                width: auto !important; /* Allow auto-sizing on smaller screens */
                height: auto !important;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            .info-panel, .market-panel, .action-panel, .inventory-panel, .status-panel, .tomorrow-panel, .game-panel {
                grid-column: span 1;
            }
        }
        /* Specific max-height for tables within World Prices and Quantities & World Cities modals */
        #world-prices-quantities-modal .table-container,
        #world-cities-modal .table-container {
            max-height: 550px; /* Increased to show more items without scroll */
        }
    </style>
</head>
<body>
    <div class="game-container" id="game-container">
        <div class="panel info-panel">
            <div class="panel-title">Information</div>
            <div id="info-display" class="w-full h-40 bg-gray-700 border border-gray-600 rounded-md p-3 text-gray-200" style="overflow-y: auto;">
Welcome to Drug Lord! Your goal is to make as much money as possible by buying and selling drugs. You start with $10000 cash and a $1000 debt to Buddles, a loan shark. Pay him back quickly, or face the consequences! Travel between cities to find the best prices. Good luck!
            </div>
        </div>

        <div class="panel market-panel">
            <div class="panel-title">The Market</div>
            <div class="table-container">
                <table id="market-table">
                    <thead>
                        <tr>
                            <th></th> <!-- For trend icon -->
                            <th>Name</th>
                            <th>Qty</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Market rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row gap-2">
                <input type="number" id="trade-quantity" class="input-field flex-grow" placeholder="Quantity" min="1">
                <button id="buy-btn" class="btn">Buy &gt;&gt;</button>
            </div>
        </div>

        <div class="panel action-panel flex flex-col gap-3">
            <div class="panel-title">Action</div>
            <button id="sell-btn" class="btn">Sell</button>
            <button id="dump-btn" class="btn">Dump...</button>
            <button id="finances-btn" class="btn">Finances...</button>
            <button id="shopping-btn" class="btn">Shopping...</button>
            <button id="hospital-btn" class="btn">Hospital...</button>
            <button id="vault-btn" class="btn">Vault...</button>
            <button id="shipping-btn" class="btn">Shipping...</button>
            <button id="shipment-status-btn" class="btn">Shipment Status Info...</button>
            <button id="info-btn" class="btn">Info...</button>
        </div>

        <div class="panel inventory-panel">
            <div class="panel-title">Your pants pocket (<span id="inventory-count">0</span>/<span id="inventory-limit">10</span>)</div>
            <div class="table-container">
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Qty</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="panel status-panel">
            <div class="panel-title">Status</div>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Location:</span>
                    <span id="status-location" class="status-value"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Health:</span>
                    <span id="status-health" class="status-value"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Day:</span>
                    <span id="status-day" class="status-value"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rank:</span>
                    <span id="status-rank" class="status-value">Newbie</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Cash:</span>
                    <span id="status-cash" class="status-value"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Bank:</span>
                    <span id="status-bank" class="status-value"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Debt:</span>
                    <span id="status-debt" class="status-value"></span>
                </div>
            </div>
        </div>

        <div class="panel tomorrow-panel flex flex-col gap-3">
            <div class="panel-title">Tomorrow</div>
            <button id="stay-here-btn" class="btn">Stay Here</button>
            <button id="fly-away-btn" class="btn">Fly Away...</button>
        </div>

        <div class="panel game-panel flex flex-col gap-3">
            <div class="panel-title">Game</div>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="sound-toggle" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                <span class="text-gray-200">Sound</span>
            </label>
            <button id="about-btn" class="btn">About...</button>
            <button id="docs-btn" class="btn">Docs...</button>
            <button id="high-scores-btn" class="btn">High Scores...</button>
            <button id="new-game-btn" class="btn">New Game</button>
            <button id="quit-btn" class="btn">Quit</button>
        </div>
    </div>

    <div id="message-box" class="message-box">
        <div class="panel-title">Message <button class="close-btn" data-modal-id="message-box">&times;</button></div> <div id="message-box-content" class="message-box-content"></div>
        <div class="message-box-actions">
            </div>
    </div>

    <div id="places-modal" class="message-box">
        <div class="panel-title">Places <button class="close-btn" data-modal-id="places-modal">&times;</button></div>
        <div class="table-container w-full">
            <table id="places-table">
                <thead>
                    <tr>
                        <th>City</th>
                        <th>Travel Cost</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
                </table>
        </div>
        <div class="mt-4 flex gap-2">
            <button id="travel-btn" class="btn">Travel</button>
            <button id="places-modal-close-btn" class="btn">Close</button>
        </div>
    </div>

    <div id="finances-modal" class="message-box">
        <div class="panel-title">Bank & Loans <button class="close-btn" data-modal-id="finances-modal">&times;</button></div>
        <div class="w-full flex flex-col gap-4">
            <div class="panel">
                <div class="panel-title">Bank</div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>Cash: <span id="bank-cash-display">$0</span></div>
                    <div>In Bank: <span id="bank-bank-display">$0</span></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 mb-3">
                    <input type="number" id="bank-amount-input" class="input-field flex-grow" placeholder="Amount" min="0">
                    <button id="deposit-btn" class="btn">Deposit</button>
                    <button id="withdraw-btn" class="btn">Withdraw</button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="deposit-all-btn" class="btn text-sm">Deposit All</button>
                    <button id="withdraw-all-btn" class="btn text-sm">Withdraw All</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Loans</div>
                <div class="table-container mb-3">
                    <table id="loans-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Rate</th>
                                <th>Days</th>
                                <th>Debt</th>
                                <th>Days Left</th>
                                <th>Max Loan</th> </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="number" id="loan-amount-input" class="input-field flex-grow" placeholder="Borrow Amount" min="0">
                    <button id="borrow-loan-btn" class="btn">Borrow...</button>
                    <button id="repay-loan-btn" class="btn">Repay</button>
                </div>
            </div>
        </div>
        <button id="finances-modal-close-btn" class="btn mt-4">Done</button>
    </div>

    <div id="shopping-modal" class="message-box">
        <div class="panel-title">Shopping <button class="close-btn" data-modal-id="shopping-modal">&times;</button></div>
        <div class="w-full flex flex-col gap-4">
            <div class="panel">
                <div class="panel-title">Store's Inventory</div>
                <div class="table-container mb-3">
                    <table id="store-inventory-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="number" id="shop-quantity-input" class="input-field flex-grow" placeholder="Quantity" min="1">
                    <button id="shop-buy-btn" class="btn">Buy</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Your Inventory</div>
                <div class="table-container mb-3">
                    <table id="player-item-inventory-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Qty</th>
                                <th>Sell for</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="shop-sell-btn" class="btn">Sell</button>
                </div>
            </div>
            <div class="text-right text-gray-300">Cash: <span id="shop-cash-display">$0</span></div>
        </div>
        <button id="shopping-modal-close-btn" class="btn mt-4">Done</button>
    </div>

    <div id="hospital-modal" class="message-box">
        <div class="panel-title">Hospital <button class="close-btn" data-modal-id="hospital-modal">&times;</button></div>
        <div class="w-full flex flex-col gap-4">
            <div class="flex items-center gap-4">
                <img src="https://placehold.co/60x60/4299e1/ffffff?text=⚕️" alt="Caduceus" class="rounded-full">
                <div class="flex-grow">
                    <label for="health-slider" class="block text-gray-300 mb-2">Move the pointer to desired health</label>
                    <input type="range" id="health-slider" min="0" max="100" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>Cash: <span id="hospital-cash-display">$0</span></div>
                <div>Current Health: <span id="hospital-current-health">100</span></div>
                <div>Cost for treatment: <span id="treatment-cost">$0</span></div>
                <div>Desired Health: <span id="desired-health-display">0</span></div>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button id="treat-btn" class="btn">Treat</button>
            <button id="hospital-modal-close-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="vault-modal" class="message-box">
        <div class="panel-title">The Vault <button class="close-btn" data-modal-id="vault-modal">&times;</button></div>
        <div class="w-full grid grid-cols-2 gap-4">
            <div class="panel">
                <div class="panel-title">Your pants pocket (<span id="vault-pocket-count">0</span>/<span id="vault-pocket-limit">10</span>)</div>
                <div class="table-container mb-3">
                    <table id="vault-pocket-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Qty</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="flex flex-col justify-center items-center gap-4">
                <input type="number" id="vault-quantity-input" class="input-field w-32" placeholder="Qty" min="1">
                <button id="into-vault-btn" class="btn w-32">Into Vault &gt;&gt;</button>
                <button id="from-vault-btn" class="btn w-32">&lt;&lt; From Vault</button>
            </div>

            <div class="panel">
                <div class="panel-title">In the Vault</div>
                <div class="table-container mb-3">
                    <table id="vault-storage-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Qty</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button id="vault-modal-ok-btn" class="btn">OK</button>
            <button id="vault-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="shipping-modal" class="message-box">
        <div class="panel-title">Shipping from <span id="shipping-current-location"></span> <button class="close-btn" data-modal-id="shipping-modal">&times;</button></div>
        <div class="w-full grid grid-cols-3 gap-4">
            <div class="panel">
                <div class="panel-title">Your stock</div>
                <div class="table-container mb-3">
                    <table id="shipping-stock-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="flex flex-col justify-center items-center gap-4">
                <input type="number" id="shipping-quantity-input" class="input-field w-32" placeholder="Qty" min="1">
                <button id="ship-item-btn" class="btn w-32">Ship &gt;&gt;</button>
                <button id="dont-ship-item-btn" class="btn w-32">&lt;&lt; Don't Ship</button>
            </div>

            <div class="panel">
                <div class="panel-title">What you are shipping</div>
                <div class="table-container mb-3">
                    <table id="shipping-list-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel col-span-1">
                <div class="panel-title">Destination</div>
                <div class="table-container mb-3">
                    <table id="shipping-destination-table">
                        <thead>
                            <tr>
                                <th>City</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel col-span-2">
                <div class="panel-title">Delivery</div>
                <div class="flex flex-wrap gap-4 mb-3">
                    <label class="flex items-center gap-1">
                        <input type="radio" name="delivery-time" value="3" checked class="form-radio text-blue-600">
                        <span>Three-day</span>
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="radio" name="delivery-time" value="2" class="form-radio text-blue-600">
                        <span>Two-day</span>
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="radio" name="delivery-time" value="1" class="form-radio text-blue-600">
                        <span>Overnight</span>
                    </label>
                </div>
                <div class="panel-title">Select a shipper</div>
                <div class="table-container mb-3">
                    <table id="shipping-shipper-table">
                        <thead>
                            <tr>
                                <th>Shipper</th>
                                <th>Cost</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div class="text-right text-gray-300">Total Cost: <span id="shipping-total-cost">$0</span></div>
            </div>
        </div>
        <div class="mt-4 flex gap-2">
            <button id="confirm-ship-btn" class="btn">OK</button>
            <button id="shipping-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="sell-drug-modal" class="message-box">
        <div id="sell-drug-modal-title" class="panel-title">Selling Drug <button class="close-btn" data-modal-id="sell-drug-modal">&times;</button></div>
        <div id="sell-drug-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="sell-drug-quantity-input" class="block text-gray-300">How many do you wish to sell?</label>
            <input type="number" id="sell-drug-quantity-input" class="input-field" placeholder="Quantity" min="1">
        </div>
        <div class="message-box-actions mt-4">
            <button id="sell-drug-modal-ok-btn" class="btn">OK</button>
            <button id="sell-drug-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="buy-drug-modal" class="message-box">
        <div id="buy-drug-modal-title" class="panel-title">Buying Drug <button class="close-btn" data-modal-id="buy-drug-modal">&times;</button></div>
        <div id="buy-drug-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="buy-drug-quantity-input" class="block text-gray-300">How many do you wish to buy?</label>
            <input type="number" id="buy-drug-quantity-input" class="input-field" placeholder="Quantity" min="1">
        </div>
        <div class="message-box-actions mt-4">
            <button id="buy-drug-modal-ok-btn" class="btn">OK</button>
            <button id="buy-drug-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="info-options-modal" class="message-box">
        <div class="panel-title">Information Options <button class="close-btn" data-modal-id="info-options-modal">&times;</button></div>
        <div class="message-box-content">What information would you like to view?</div>
        <div class="message-box-actions flex flex-col gap-3 w-full">
            <button id="view-world-prices-btn" class="btn">World Prices and Quantities</button>
            <button id="view-world-cities-btn" class="btn">World Cities</button>
            <button id="info-options-modal-close-btn" class="btn">Close</button>
        </div>
    </div>

    <div id="world-prices-quantities-modal" class="message-box">
        <div class="panel-title">World Prices and Quantities <button class="close-btn" data-modal-id="world-prices-quantities-modal">&times;</button></div>
        <div class="w-full grid grid-cols-2 gap-4">
            <div class="panel">
                <div class="panel-title">Drug</div>
                <div class="table-container mb-3">
                    <table id="world-prices-drug-table">
                        <thead>
                            <tr>
                                <th>Drug Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">City List</div>
                <div class="table-container mb-3">
                    <table id="world-prices-city-list-table">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Qty</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button id="world-prices-quantities-modal-close-btn" class="btn mt-4">Close</button>
    </div>

    <div id="world-cities-modal" class="message-box">
        <div class="panel-title">World Cities <button class="close-btn" data-modal-id="world-cities-modal">&times;</button></div>
        <div class="w-full grid grid-cols-2 gap-4">
            <div class="panel">
                <div class="panel-title">City</div>
                <div class="table-container mb-3">
                    <table id="world-cities-city-table">
                        <thead>
                            <tr>
                                <th>City Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="panel">
                <div class="panel-title">Drug List</div>
                <div class="table-container mb-3">
                    <table id="world-cities-drug-list-table">
                        <thead>
                            <tr>
                                <th>Drug</th>
                                <th>Qty</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button id="world-cities-modal-close-btn" class="btn mt-4">Close</button>
    </div>

    <div id="dump-drug-modal" class="message-box">
        <div id="dump-drug-modal-title" class="panel-title"></div> <button class="close-btn" data-modal-id="dump-drug-modal">&times;</button>
        <div id="dump-drug-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="dump-drug-quantity-input" class="block text-gray-300">How many do you wish to dump?</label>
            <input type="number" id="dump-drug-quantity-input" class="input-field" placeholder="Quantity" min="1">
        </div>
        <div class="message-box-actions mt-4">
            <button id="dump-drug-modal-ok-btn" class="btn">OK</button>
            <button id="dump-drug-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="shipment-status-modal" class="message-box">
        <div class="panel-title">Shipments <button class="close-btn" data-modal-id="shipment-status-modal">&times;</button></div>
        <div class="table-container w-full">
            <table id="shipment-status-table">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>Going to</th>
                        <th>Arriving in</th> <!-- Changed from Arrival Day -->
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <button id="shipment-status-modal-close-btn" class="btn mt-4">Close</button>
    </div>

    <div id="using-no-scent-modal" class="message-box">
        <div class="panel-title">Using No-Scent <button class="close-btn" data-modal-id="using-no-scent-modal">&times;</button></div>
        <div id="using-no-scent-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="no-scent-quantity-input" class="block text-gray-300">How many cans do you wish to use?</label>
            <input type="number" id="no-scent-quantity-input" class="input-field" placeholder="Quantity" min="0">
        </div>
        <div class="message-box-actions mt-4">
            <button id="no-scent-modal-ok-btn" class="btn">OK</button>
            <button id="no-scent-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="airport-security-modal" class="message-box">
        <div class="panel-title">Fighting Airport Security <button class="close-btn" data-modal-id="airport-security-modal">&times;</button></div>
        <div class="w-full flex flex-col gap-4">
            <div class="panel">
                <div class="panel-title">Information</div>
                <div class="text-gray-200 text-left mb-2">
                    <span class="font-bold">Fighting:</span> <span id="security-enemy-type">Airport Security</span><br>
                    <span class="font-bold"># Left:</span> <span id="security-left-count"></span>
                </div>
                <!-- This will act as the RICHEDIT control for fight logs -->
                <div id="airport-security-info" class="w-full h-24 bg-gray-700 border border-gray-600 rounded-md p-3 text-gray-200" style="overflow-y: auto;">
                    You have encountered airport security! There are <span id="initial-security-count"></span> of them!
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Health</div>
                <div class="w-full bg-gray-600 rounded-full h-4">
                    <div id="player-health-bar" class="bg-green-500 h-4 rounded-full" style="width: 100%;"></div>
                </div>
                <div class="text-right text-gray-300 mt-1">Your Health: <span id="player-health-display"></span></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="panel flex flex-col gap-2">
                    <div class="panel-title">Do something!</div>
                    <button id="surrender-btn" class="btn bg-red-600 hover:bg-red-700">Surrender</button>
                    <button id="run-btn" class="btn bg-yellow-600 hover:bg-yellow-700">Run</button>
                    <button id="bribe-btn" class="btn bg-purple-600 hover:bg-purple-700">Bribe...</button>
                    <button id="fight-btn" class="btn bg-green-600 hover:bg-green-700">Fight</button>
                </div>

                <div class="panel">
                    <div class="panel-title">Weapon & Ammo</div>
                    <div class="table-container mb-3" style="max-height: 100px;">
                        <table id="security-weapon-table">
                            <thead>
                                <tr>
                                    <th>Weapon</th>
                                    <th>Ammo</th>
                                </tr>
                            </thead>
                        <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <button id="airport-security-modal-close-btn" class="btn mt-4 hidden">Close</button>
    </div>

    <div id="sell-item-modal" class="message-box">
        <div id="sell-item-modal-title" class="panel-title">Selling Item <button class="close-btn" data-modal-id="sell-item-modal">&times;</button></div>
        <div id="sell-item-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="sell-item-quantity-input" class="block text-gray-300">How many do you wish to sell?</label>
            <input type="number" id="sell-item-quantity-input" class="input-field" placeholder="Quantity" min="1">
        </div>
        <div class="message-box-actions mt-4">
            <button id="sell-item-modal-ok-btn" class="btn">OK</button>
            <button id="sell-item-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="buy-item-quantity-modal" class="message-box">
        <div id="buy-item-quantity-modal-title" class="panel-title">Buying Item <button class="close-btn" data-modal-id="buy-item-quantity-modal">&times;</button></div>
        <div id="buy-item-quantity-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="buy-item-quantity-input" class="block text-gray-300">How many do you wish to buy?</label>
            <input type="number" id="buy-item-quantity-input" class="input-field" placeholder="Quantity" min="1">
        </div>
        <div class="message-box-actions mt-4">
            <button id="buy-item-quantity-modal-ok-btn" class="btn">OK</button>
            <button id="buy-item-quantity-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <div id="borrow-amount-modal" class="message-box">
        <div id="borrow-amount-modal-title" class="panel-title">Borrow Amount <button class="close-btn" data-modal-id="borrow-amount-modal">&times;</button></div>
        <div id="borrow-amount-modal-message" class="message-box-content text-left"></div>
        <div class="w-full flex flex-col gap-2 mt-4">
            <label for="borrow-input-field" class="block text-gray-300">Amount to Borrow:</label>
            <input type="number" id="borrow-input-field" class="input-field" placeholder="Amount" min="0">
        </div>
        <div class="message-box-actions mt-4">
            <button id="borrow-amount-modal-ok-btn" class="btn">Borrow</button>
            <button id="borrow-amount-modal-cancel-btn" class="btn">Cancel</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Game State Variables
        let player = {
            cash: 10000,
            bank: 0,
            debt: 1000,
            health: 100,
            day: 1,
            location: 'Austin, USA',
            inventory: [], // { name: 'Cocaine', qty: 10, purchasePrice: 500 }
            inventoryLimit: 10,
            items: [], // { name: 'Vest', qty: 1, type: 'Defense', purchasePrice: 5000, sellPrice: 3750 }
            loans: [], // { name: 'Buddles', rate: 0.07, days: 6, currentDebt: 1000, daysLeft: 6, maxLoan: 1000 }
            vault: [], // { name: 'Cocaine', qty: 10, purchasePrice: 500 }
            shipments: [], // { drugName: 'Cocaine', qty: 5, destination: 'Miami', arrivalDay: 5, purchasePrice: 500 }
        };

        const drugs = [
            { name: 'Acid', basePrice: 1000 },
            { name: 'Cocaine', basePrice: 15000 },
            { name: 'Crack', basePrice: 4000 }, // Hiked price
            { name: 'Ecstacy', basePrice: 1000 },
            { name: 'Hashish', basePrice: 1000 },
            { name: 'Heroin', basePrice: 2000 }, // Hiked price
            { name: 'Ice', basePrice: 1000 },
            { name: 'Kat', basePrice: 1000 },
            { name: 'LSD', basePrice: 5040 },
            { name: 'MDA', basePrice: 1000 },
            { name: 'Morphine', basePrice: 1000 },
            { name: 'Mushrooms', basePrice: 1000 },
            { name: 'Opium', basePrice: 1000 },
            { name: 'PCP', basePrice: 1728 },
            { name: 'Peyote', basePrice: 1000 },
            { name: 'Special K', basePrice: 1000 },
            { name: 'Speed', basePrice: 1000 },
            { name: 'Weed', basePrice: 1000 },
        ];


        const cities = [
            { name: 'Austin, USA', travelCost: 0 },
            { name: 'Beijing, China', travelCost: 3446 },
            { name: 'Boston, USA', travelCost: 648 },
            { name: 'Detroit, USA', travelCost: 102 },
            { name: 'London, England', travelCost: 2864 },
            { name: 'Los Angeles, USA', travelCost: 789 },
            { name: 'Miami, USA', travelCost: 941 },
            { name: 'Moscow, Russia', travelCost: 3252 },
            { name: 'New York, USA', travelCost: 574 },
            { name: 'Paris, France', travelCost: 3076 },
            { name: 'San Francisco, USA', travelCost: 1070 },
            { name: 'St Petersburg, Russia', travelCost: 2900 },
            { name: 'Sydney, Australia', travelCost: 5896 },
            { name: 'Toronto, Canada', travelCost: 230 },
            { name: 'Vancouver, Canada', travelCost: 1861 },
        ];

        const storeItems = [
            { name: 'Knife', type: 'Weapon', price: 100, sellPrice: 75, damage: 5, ammoType: null },
            { name: 'Pistol', type: 'Weapon', price: 500, sellPrice: 375, damage: 10, ammoType: 'Pistol Bullet' },
            { name: 'Pistol Bullet', type: 'Ammo', price: 5, sellPrice: 3, units: 10 },
            { name: 'Shot Gun', type: 'Weapon', price: 2500, sellPrice: 1875, damage: 25, ammoType: 'Shot Gun Shell' },
            { name: 'Shot Gun Shell', type: 'Ammo', price: 5, sellPrice: 3, units: 5 },
            { name: 'Machine Gun', type: 'Weapon', price: 4000, sellPrice: 3000, damage: 50, ammoType: 'Machine Gun Bullet' },
            { name: 'Machine Gun Bullet', type: 'Ammo', price: 5, sellPrice: 3, units: 20 },
            { name: 'Flame Thrower', type: 'Weapon', price: 7500, sellPrice: 5625, damage: 75, ammoType: 'Gas Canister' },
            { name: 'Gas Canister', type: 'Ammo', price: 200, sellPrice: 150, units: 1 },
            { name: 'Dynamite', type: 'Ammo', price: 250, sellPrice: 187, damage: 100, isExplosive: true },
            { name: 'Hand Grenade', type: 'Ammo', price: 500, sellPrice: 375, damage: 150, isExplosive: true },
            { name: 'Rocket Launcher', type: 'Weapon', price: 10000, sellPrice: 7500, damage: 200, ammoType: 'Rocket' },
            { name: 'Rocket', type: 'Ammo', price: 500, sellPrice: 375, units: 1 },
            { name: 'Area Disrupter', type: 'Weapon', price: 500000, sellPrice: 375000, damage: 250, ammoType: 'Energy Globe' },
            { name: 'Energy Globe', type: 'Ammo', price: 25000, sellPrice: 18750, units: 1 },
            { name: 'Heavy Leather Coat', type: 'Armor', price: 1000, sellPrice: 750 },
            { name: 'Bullet Proof Vest', type: 'Armor', price: 10000, sellPrice: 7500 },
            { name: 'Can of No-Scent', type: 'Item', price: 1000, sellPrice: 750, maxPurchase: 10, hidingCapacity: 10, inventoryMax: 10 }, 
        ];

        const loanSharks = [
            { name: 'Odd Lenny', maxLoan: 5000, rate: 0.10 * 0.80, days: 1 }, 
            { name: 'One-eyed Wilbur', maxLoan: 10000, rate: 0.12 * 0.80, days: 3 }, 
            { name: 'Laughing Max', maxLoan: 20000, rate: 0.15 * 0.80, days: 4 }, 
            { name: 'Strange ear Leonard', maxLoan: 50000, rate: 0.20 * 0.80, days: 5 }, 
        ];

        const shippers = [
            { name: 'Shipper', overnightCost: 129, description: 'Economical and reliable for standard deliveries.' },
            { name: 'Quicker Shipper', overnightCost: 259, description: 'Faster than standard, good balance of speed and cost.' },
            { name: 'Courier Stan', overnightCost: 648, description: 'Express delivery, trusted for urgent shipments.' },
            { name: 'Sharp Ship', overnightCost: 1296, description: 'Premium speed and efficiency, highly reliable.' },
            { name: 'International Couriers', overnightCost: 2000, description: 'Most secure and accurate for guaranteed international deliveries.' },
        ];

        const deliveryTimeRatios = {
            '1': 1.0,
            '2': 0.6,
            '3': 0.3
        };

        const COST_PER_UNIT_SHIPPED = 5;
        const DISTANCE_COST_FACTOR = 0.01;

        let marketPrices = {};
        let activeRumors = []; // Stores active rumors for the current day
        let pendingTravelCity = null; // New variable to store destination for interrupted travel

        // UI Elements
        const gameContainer = document.getElementById('game-container');
        const infoDisplay = document.getElementById('info-display');
        const marketTableBody = document.querySelector('#market-table tbody');
        const inventoryTableBody = document.querySelector('#inventory-table tbody');
        const tradeQuantityInput = document.getElementById('trade-quantity');
        const buyBtn = document.getElementById('buy-btn');
        const sellBtn = document.getElementById('sell-btn');
        const dumpBtn = document.getElementById('dump-btn');
        const financesBtn = document.getElementById('finances-btn');
        const shoppingBtn = document.getElementById('shopping-btn');
        const hospitalBtn = document.getElementById('hospital-btn');
        const vaultBtn = document.getElementById('vault-btn');
        const shippingBtn = document.getElementById('shipping-btn');
        const shipmentStatusBtn = document.getElementById('shipment-status-btn');
        const infoBtn = document.getElementById('info-btn');
        const stayHereBtn = document.getElementById('stay-here-btn');
        const flyAwayBtn = document.getElementById('fly-away-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const quitBtn = document.getElementById('quit-btn');
        const soundToggle = document.getElementById('sound-toggle');

        const statusLocation = document.getElementById('status-location');
        const statusHealth = document.getElementById('status-health');
        const statusDay = document.getElementById('status-day');
        const statusRank = document.getElementById('status-rank');
        const statusCash = document.getElementById('status-cash');
        const statusBank = document.getElementById('status-bank');
        const statusDebt = document.getElementById('status-debt');
        const inventoryCount = document.getElementById('inventory-count');
        const inventoryLimit = document.getElementById('inventory-limit');

        // Modals
        const messageBox = document.getElementById('message-box');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxActions = messageBox.querySelector('.message-box-actions');

        const placesModal = document.getElementById('places-modal');
        const placesTableBody = document.querySelector('#places-table tbody');
        const travelBtn = document.getElementById('travel-btn');
        const placesModalCloseBtn = document.getElementById('places-modal-close-btn');

        const financesModal = document.getElementById('finances-modal');
        const bankCashDisplay = document.getElementById('bank-cash-display');
        const bankBankDisplay = document.getElementById('bank-bank-display');
        const bankAmountInput = document.getElementById('bank-amount-input');
        const depositBtn = document.getElementById('deposit-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const depositAllBtn = document.getElementById('deposit-all-btn');
        const withdrawAllBtn = document.getElementById('withdraw-all-btn');
        const loansTableBody = document.querySelector('#loans-table tbody');
        const loanAmountInput = document.getElementById('loan-amount-input');
        const borrowLoanBtn = document.getElementById('borrow-loan-btn');
        const repayLoanBtn = document.getElementById('repay-loan-btn');
        const financesModalCloseBtn = document.getElementById('finances-modal-close-btn');

        const shoppingModal = document.getElementById('shopping-modal');
        const storeInventoryTableBody = document.querySelector('#store-inventory-table tbody');
        const playerItemInventoryTableBody = document.querySelector('#player-item-inventory-table tbody');
        const shopQuantityInput = document.getElementById('shop-quantity-input');
        const shopBuyBtn = document.getElementById('shop-buy-btn');
        const shopSellBtn = document.getElementById('shop-sell-btn');
        const shopCashDisplay = document.getElementById('shop-cash-display');
        const shoppingModalCloseBtn = document.getElementById('shopping-modal-close-btn');

        const hospitalModal = document.getElementById('hospital-modal');
        const healthSlider = document.getElementById('health-slider');
        const hospitalCashDisplay = document.getElementById('hospital-cash-display');
        const hospitalCurrentHealth = document.getElementById('hospital-current-health');
        const treatmentCostDisplay = document.getElementById('treatment-cost');
        const desiredHealthDisplay = document.getElementById('desired-health-display'); 
        const treatBtn = document.getElementById('treat-btn');
        const hospitalModalCloseBtn = document.getElementById('hospital-modal-close-btn');

        const vaultModal = document.getElementById('vault-modal');
        const vaultPocketCount = document.getElementById('vault-pocket-count');
        const vaultPocketLimit = document.getElementById('vault-pocket-limit'); 
        const vaultPocketTableBody = document.querySelector('#vault-pocket-table tbody');
        const vaultStorageTableBody = document.querySelector('#vault-storage-table tbody');
        const vaultQuantityInput = document.getElementById('vault-quantity-input');
        const intoVaultBtn = document.getElementById('into-vault-btn');
        const fromVaultBtn = document.getElementById('from-vault-btn');
        const vaultModalOkBtn = document.getElementById('vault-modal-ok-btn');
        const vaultModalCancelBtn = document.getElementById('vault-modal-cancel-btn');

        const shippingModal = document.getElementById('shipping-modal');
        const shippingCurrentLocation = document.getElementById('shipping-current-location');
        const shippingStockTableBody = document.querySelector('#shipping-stock-table tbody');
        const shippingListTableBody = document.querySelector('#shipping-list-table tbody');
        const shippingQuantityInput = document.getElementById('shipping-quantity-input');
        const shipItemBtn = document.getElementById('ship-item-btn');
        const dontShipItemBtn = document.getElementById('dont-ship-item-btn');
        const shippingDestinationTableBody = document.querySelector('#shipping-destination-table tbody');
        const shippingShipperTableBody = document.getElementById('shipping-shipper-table').querySelector('tbody');
        const shippingTotalCostDisplay = document.getElementById('shipping-total-cost');
        const confirmShipBtn = document.getElementById('confirm-ship-btn');
        const shippingModalCancelBtn = document.getElementById('shipping-modal-cancel-btn');

        const sellDrugModal = document.getElementById('sell-drug-modal');
        const sellDrugModalTitle = document.getElementById('sell-drug-modal-title');
        const sellDrugModalMessage = document.getElementById('sell-drug-modal-message');
        const sellDrugQuantityInput = document.getElementById('sell-drug-quantity-input');
        const sellDrugModalOkBtn = document.getElementById('sell-drug-modal-ok-btn');
        const sellDrugModalCancelBtn = document.getElementById('sell-drug-modal-cancel-btn');

        const buyDrugModal = document.getElementById('buy-drug-modal');
        const buyDrugModalTitle = document.getElementById('buy-drug-modal-title');
        const buyDrugModalMessage = document.getElementById('buy-drug-modal-message');
        const buyDrugQuantityInput = document.getElementById('buy-drug-quantity-input');
        const buyDrugModalOkBtn = document.getElementById('buy-drug-modal-ok-btn');
        const buyDrugModalCancelBtn = document.getElementById('buy-drug-modal-cancel-btn');

        const infoOptionsModal = document.getElementById('info-options-modal');
        const viewWorldPricesBtn = document.getElementById('view-world-prices-btn');
        const viewWorldCitiesBtn = document.getElementById('view-world-cities-btn');
        const infoOptionsModalCloseBtn = document.getElementById('info-options-modal-close-btn');

        const worldPricesQuantitiesModal = document.getElementById('world-prices-quantities-modal');
        const worldPricesDrugTableBody = document.querySelector('#world-prices-drug-table tbody');
        const worldPricesCityListTableBody = document.querySelector('#world-prices-city-list-table tbody');
        const worldPricesQuantitiesModalCloseBtn = document.getElementById('world-prices-quantities-modal-close-btn');

        const worldCitiesModal = document.getElementById('world-cities-modal');
        const worldCitiesCityTableBody = document.querySelector('#world-cities-city-table tbody');
        const worldCitiesDrugListTableBody = document.querySelector('#world-cities-drug-list-table tbody');
        const worldCitiesModalCloseBtn = document.getElementById('world-cities-modal-close-btn');

        const dumpDrugModal = document.getElementById('dump-drug-modal');
        const dumpDrugModalTitle = document.getElementById('dump-drug-modal-title');
        const dumpDrugModalMessage = document.getElementById('dump-drug-modal-message');
        const dumpDrugQuantityInput = document.getElementById('dump-drug-quantity-input');
        const dumpDrugModalOkBtn = document.getElementById('dump-drug-modal-ok-btn');
        const dumpDrugModalCancelBtn = document.getElementById('dump-drug-modal-cancel-btn');

        const shipmentStatusModal = document.getElementById('shipment-status-modal');
        const shipmentStatusTableBody = document.querySelector('#shipment-status-table tbody');
        const shipmentStatusModalCloseBtn = document.getElementById('shipment-status-modal-close-btn');

        const usingNoScentModal = document.getElementById('using-no-scent-modal');
        const usingNoScentMessage = document.getElementById('using-no-scent-message');
        const noScentQuantityInput = document.getElementById('no-scent-quantity-input');
        const noScentModalOkBtn = document.getElementById('no-scent-modal-ok-btn');
        const noScentModalCancelBtn = document.getElementById('no-scent-modal-cancel-btn');

        const airportSecurityModal = document.getElementById('airport-security-modal');
        const securityEnemyType = document.getElementById('security-enemy-type'); // New element
        const initialSecurityCount = document.getElementById('initial-security-count'); // New element
        const securityLeftCount = document.getElementById('security-left-count');
        const playerHealthBar = document.getElementById('player-health-bar');
        const playerHealthDisplay = document.getElementById('player-health-display');
        const surrenderBtn = document.getElementById('surrender-btn');
        const runBtn = document.getElementById('run-btn'); 
        const bribeBtn = document.getElementById('bribe-btn');
        const fightBtn = document.getElementById('fight-btn');
        const securityWeaponTableBody = document.querySelector('#security-weapon-table tbody');
        const airportSecurityModalCloseBtn = document.getElementById('airport-security-modal-close-btn');
        const airportSecurityInfo = document.getElementById('airport-security-info'); // Re-purposed for dynamic log

        const sellItemModal = document.getElementById('sell-item-modal');
        const sellItemModalTitle = document.getElementById('sell-item-modal-title');
        const sellItemModalMessage = document.getElementById('sell-item-modal-message');
        const sellItemQuantityInput = document.getElementById('sell-item-quantity-input');
        const sellItemModalOkBtn = document.getElementById('sell-item-modal-ok-btn');
        const sellItemModalCancelBtn = document.getElementById('sell-item-modal-cancel-btn');

        const buyItemQuantityModal = document.getElementById('buy-item-quantity-modal');
        const buyItemQuantityModalTitle = document.getElementById('buy-item-quantity-modal-title');
        const buyItemQuantityModalMessage = document.getElementById('buy-item-quantity-modal-message');
        const buyItemQuantityInput = document.getElementById('buy-item-quantity-input');
        const buyItemQuantityModalOkBtn = document.getElementById('buy-item-quantity-modal-ok-btn');
        const buyItemQuantityModalCancelBtn = document.getElementById('buy-item-quantity-modal-cancel-btn');

        const borrowAmountModal = document.getElementById('borrow-amount-modal');
        const borrowAmountModalTitle = document.getElementById('borrow-amount-modal-title');
        const borrowAmountModalMessage = document.getElementById('borrow-amount-modal-message');
        const borrowInputField = document.getElementById('borrow-input-field');
        const borrowAmountModalOkBtn = document.getElementById('borrow-amount-modal-ok-btn');
        const borrowAmountModalCancelBtn = document.getElementById('borrow-amount-modal-cancel-btn');


        let selectedMarketDrug = null;
        let selectedInventoryDrug = null;
        let selectedTravelCity = null;
        let selectedLoan = null;
        let selectedStoreItem = null;
        let selectedPlayerItem = null;
        let selectedVaultPocketDrug = null;
        let selectedVaultStorageDrug = null;
        let selectedShippingStockDrug = null;
        let selectedShippingListDrug = null;
        let selectedShippingDestination = null;
        let selectedShipper = null;
        let currentShippingList = [];

        let selectedWorldPricesDrug = null;
        let selectedWorldCitiesCity = null;

        let airportSecurity = {
            enemiesLeft: 0,
            initialEnemies: 0,
            playerWeapon: null
        };

        const soundUrls = {
            'day_advance': 'https://mrkay83.github.io/drug-lord-game-assets/day_advance.mp3',
            'buy': 'https://mrkay83.github.io/drug-lord-game-assets/buy.mp3',
            'sell': 'https://mrkay83.github.io/drug-lord-game-assets/sell.mp3',
            'dump': 'https://mrkay83.github.io/drug-lord-game-assets/Dump.mp3',
            'travel': 'https://mrkay83.github.io/drug-lord-game-assets/travel.mp3',
            'shipment_arrive': 'https://mrkay83.github.io/drug-lord-game-assets/shipment_arrive.mp3',
            'lender_collect': 'https://raw.githubusercontent.com/MrKay83/drug-lord-game-assets/main/Where-is-my-money.mp3', 
            'loan_repay': 'https://github.com/MrKay83/drug-lord-game-assets/raw/main/When-paying-back.mp3', 
            'buy_item': 'https://mrkay83.github.io/drug-lord-game-assets/Buying.mp3',
            'fly_away': 'https://raw.githubusercontent.com/MrKay83/drug-lord-game-assets/main/Fly-away.mp3',
            'vault_move': 'https://raw.githubusercontent.com/MrKay83/drug-lord-game-assets/main/Vault.mp3',
            'hospital': 'https://github.com/MrKay83/drug-lord-game-assets/raw/main/Hospital.mp3',
            'run': 'https://github.com/MrKay83/drug-lord-game-assets/raw/main/Run.mp3',
            'end_game': 'https://github.com/MrKay83/drug-lord-game-assets/raw/main/end-game.mp3',
            'health_decline': 'https://raw.githubusercontent.com/MrKay83/drug-lord-game-assets/main/Hello-there.mp3', 
            'robbed': 'https://github.com/MrKay83/drug-lord-game-assets/raw/main/When-you-get-robbed.mp3', // New sound for being robbed
        };

        /**
         * Plays a sound effect.
         * @param {string} type - The type of sound to play (e.g., 'day_advance', 'lender_collect').
         */
        function playSound(type) {
            console.log(`[Sound Debug] Attempting to play sound: ${type}`);
            console.log(`[Sound Debug] Sound toggle checked: ${soundToggle.checked}`);
            console.log(`[Sound Debug] Sound URL for ${type}: ${soundUrls[type]}`);

            if (soundToggle.checked && soundUrls[type]) {
                try {
                    const audio = new Audio(soundUrls[type]);
                    audio.load(); // Preload the audio
                    console.log(`[Sound Debug] Audio object created and load() called for ${type}.`);

                    audio.play().then(() => {
                        console.log(`[Sound Debug] Sound ${type} played successfully.`);
                    }).catch(e => {
                        console.warn(`[Sound Error] Browser blocked sound (${type}) or other play error:`, e);
                        // Provide user feedback if sound is critical and consistently blocked
                        // showMessageBox("Sound could not be played. Your browser might be blocking autoplay.", [{text: 'OK', value: 'ok'}]);
                    });
                } catch (e) {
                    console.error(`[Sound Error] Failed to create Audio object or play for ${type}:`, e);
                }
            } else {
                console.log(`[Sound Debug] Sound ${type} not played: toggle is off or URL is missing.`);
            }
        }

        // SVG icon strings for up and down arrows with colored background and black arrow
        const svgUpArrow = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32px" height="32px">
                <!-- Green background rectangle with black outline -->
                <rect x="1" y="1" width="30" height="30" fill="green" stroke="black" stroke-width="2" rx="6" ry="6"/>
                <!-- Black arrow path, scaled and translated to fit, with black stroke -->
                <path d="M7 14l5-5 5 5H7z" fill="black" stroke="black" stroke-width="2" transform="translate(1.6, 1.6) scale(1.2)"/>
            </svg>
        `;
        const svgDownArrow = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32px" height="32px">
                <!-- Red background rectangle with black outline -->
                <rect x="1" y="1" width="30" height="30" fill="red" stroke="black" stroke-width="2" rx="6" ry="6"/>
                <!-- Black arrow path, scaled and translated to fit, with black stroke -->
                <path d="M7 10l5 5 5-5H7z" fill="black" stroke="black" stroke-width="2" transform="translate(1.6, 1.6) scale(1.2)"/>
            </svg>
        `;

        const allModals = [
            messageBox, placesModal, financesModal, shoppingModal, hospitalModal, vaultModal,
            shippingModal, sellDrugModal, buyDrugModal, infoOptionsModal,
            worldPricesQuantitiesModal, worldCitiesModal, dumpDrugModal,
            shipmentStatusModal, usingNoScentModal, airportSecurityModal, sellItemModal,
            buyItemQuantityModal, borrowAmountModal
        ];


        /**
         * Disables interaction with the main game UI.
         */
        function disableGameUI() {
            gameContainer.classList.add('pointer-events-none');
        }

        /**
         * Enables interaction with the main game UI.
         */
        function enableGameUI() {
            gameContainer.classList.remove('pointer-events-none');
        }


        /**
         * Displays a custom message box with configurable buttons.
         * @param {string} message - The message to display.
         * @param {Array<Object>} buttonsConfig - An array of button configurations.
         * Each object: { text: string, value: any, style: string (optional, e.g., 'green') }
         * @param {function} [onCloseCallback] - Optional callback function to execute when the message box closes.
         * @returns {Promise<any>} - Resolves with the 'value' of the clicked button.
         */
        function showMessageBox(message, buttonsConfig, onCloseCallback = null) {
            return new Promise((resolve) => {
                closeAllModals();
                disableGameUI();

                messageBoxContent.textContent = message;
                messageBox.style.display = 'flex';

                messageBoxActions.innerHTML = '';

                buttonsConfig.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.classList.add('btn');
                    button.style.margin = '0 10px';

                    if (btnConfig.style === 'green') {
                        button.classList.add('bg-green-600', 'hover:bg-green-700');
                    } else {
                        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }

                    const listener = () => {
                        messageBox.style.display = 'none';
                        messageBoxActions.innerHTML = '';
                        enableGameUI();
                        if (onCloseCallback) {
                            onCloseCallback();
                        }
                        resolve(btnConfig.value);
                    };

                    button.addEventListener('click', listener);
                    messageBoxActions.appendChild(button);
                });
            });
        }

        /**
         * Closes all active modal windows by setting their display style to 'none'.
         */
        function closeAllModals() {
            allModals.forEach(modal => {
                if (modal && modal.style.display !== 'none') {
                    modal.style.display = 'none';
                }
            });
        }

        /**
         * Updates the state of Buy/Sell/Dump buttons.
         */
        function updateTradeButtons() {
            buyBtn.disabled = !selectedMarketDrug;
            sellBtn.disabled = !selectedInventoryDrug;
            dumpBtn.disabled = !selectedInventoryDrug;
        }

        /**
         * Updates the state of the Travel button in the places modal.
         */
        function updateTravelButton() {
            travelBtn.disabled = !selectedTravelCity || selectedTravelCity.name === player.location;
        }

        /**
         * Updates the state of the loan buttons in the finances modal.
         */
        function updateLoanButtons() {
            const canBorrowFromSelected = selectedLoan && 
                                          (loanSharks.some(ls => ls.name === selectedLoan.name && (!player.loans.some(pl => pl.name === selectedLoan.name) || player.loans.find(pl => pl.name === selectedLoan.name).currentDebt === 0)));

            borrowLoanBtn.disabled = !canBorrowFromSelected;
            
            const canRepaySelected = selectedLoan && player.loans.some(pl => pl.name === selectedLoan.name && pl.currentDebt > 0);
            repayLoanBtn.disabled = !canRepaySelected;
        }

        /**
         * Updates the state of the shop buttons.
         */
        function updateShopButtons() {
            shopBuyBtn.disabled = !selectedStoreItem;
            shopSellBtn.disabled = !selectedPlayerItem;
            
            if (selectedStoreItem && selectedStoreItem.name === 'Can of No-Scent') {
                const existingNoScent = player.items.find(item => item.name === 'Can of No-Scent');
                const currentCans = existingNoScent ? existingNoScent.qty : 0;
                const maxAllowedToBuy = Math.min(selectedStoreItem.maxPurchase, selectedStoreItem.inventoryMax - currentCans);
                shopQuantityInput.max = maxAllowedToBuy;
                shopQuantityInput.value = Math.max(1, maxAllowedToBuy);
                if (maxAllowedToBuy <= 0) {
                    shopBuyBtn.disabled = true;
                }
            } else {
                shopQuantityInput.removeAttribute('max');
                shopQuantityInput.value = 1;
            }
        }

        /**
         * Updates the state of the vault buttons.
         */
        function updateVaultButtons() {
            intoVaultBtn.disabled = !selectedVaultPocketDrug;
            fromVaultBtn.disabled = !selectedVaultStorageDrug;
        }

        /**
         * Updates the UI for the airport security modal.
         */
        function updateAirportSecurityUI() {
            // Update enemy count and player health displays
            securityLeftCount.textContent = airportSecurity.enemiesLeft;
            playerHealthDisplay.textContent = player.health;
            playerHealthBar.style.width = `${player.health}%`;
            playerHealthBar.classList.toggle('bg-red-500', player.health < 30);
            playerHealthBar.classList.toggle('bg-yellow-500', player.health >= 30 && player.health < 70);
            playerHealthBar.classList.toggle('bg-green-500', player.health >= 70);

            // Dynamically update the 'Fighting:' and '# Left:' labels
            securityEnemyType.textContent = 'Airport Security'; // Assuming fixed enemy type for now

            renderSecurityWeaponTable();

            const disableActions = airportSecurity.enemiesLeft <= 0 || player.health <= 0;
            surrenderBtn.disabled = disableActions;
            runBtn.disabled = disableActions;
            bribeBtn.disabled = disableActions;
            fightBtn.disabled = disableActions || !airportSecurity.playerWeapon;
        }


        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase user ID:", userId);
                            isAuthReady = true;
                            await loadGameState(); // This will handle initial game state or prompt for new game
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (authError) {
                                console.warn("Custom token sign-in failed, falling back to anonymous sign-in:", authError);
                                await signInAnonymously(auth); // Fallback to anonymous sign-in
                            }
                        }
                    });
                } else {
                    console.warn("Firebase config not provided. Game state will not be saved/loaded.");
                    isAuthReady = true;
                    // If no firebase, behave as if no saved game, prompt new game.
                    displayInfo("Firebase is not configured. Game progress will not be saved. Click 'New Game' to start playing locally.");
                    updateUIForNoGame(); // New function to set initial UI
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("Error initializing game. Please try again. Game state may not be saved.", [{text: 'OK', value: 'ok'}]);
                isAuthReady = true;
                updateUIForNoGame(); // Set initial UI on error
            }
        }

        /**
         * Saves the current game state to Firestore.
         */
        async function saveGameState() {
            if (!isAuthReady || !userId) {
                console.warn("Firebase not ready or user not authenticated. Cannot save game state.");
                return;
            }
            try {
                const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameStates`, 'currentGame');
                await setDoc(gameDocRef, {
                    player: JSON.stringify(player),
                    marketPrices: JSON.stringify(marketPrices),
                    activeRumors: JSON.stringify(activeRumors), // Save active rumors
                    timestamp: new Date()
                });
                console.log("Game state saved successfully!");
            } catch (error) {
                console.error("Error saving game state:", error);
                showMessageBox("Failed to save game progress.", [{text: 'OK', value: 'ok'}]);
            }
        }

        /**
         * Loads the game state from Firestore.
         */
        async function loadGameState() {
            if (!isAuthReady || !userId) {
                console.warn("Firebase not ready or user not authenticated. Cannot load game state.");
                // Instead of resetGameAndStart, call a function to set initial UI
                displayInfo("No user authenticated. Game state will not be saved. Click 'New Game' to start playing locally.");
                updateUIForNoGame();
                return;
            }
            try {
                const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameStates`, 'currentGame');
                const docSnap = await getDoc(gameDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    player = JSON.parse(data.player);
                    marketPrices = JSON.parse(data.marketPrices);
                    activeRumors = data.activeRumors ? JSON.parse(data.activeRumors) : []; // Load active rumors
                    console.log("Game state loaded successfully!");
                    displayInfo(`Game loaded! Welcome back, Drug Lord ${userId.substring(0, 8)}...`);
                    updateMarket(); // Ensure market is updated based on loaded state
                    updateUI(); // Update UI to reflect loaded game
                    enableGameUIButtons(); // Enable buttons after loading game
                } else {
                    console.log("No saved game found. Prompting to start a new game.");
                    displayInfo("No saved game found. Click 'New Game' to start your journey!");
                    updateUIForNoGame(); // Set initial UI
                }
            }
            catch (error) {
                console.error("Error loading game state:", error);
                showMessageBox("Failed to load game progress. Please click 'New Game' to start a new game.", [{text: 'OK', value: 'ok'}]);
                updateUIForNoGame(); // Set initial UI on error
            }
        }
        /**
         * Generates random quantity for a drug in the market.
         * @returns {number} - The generated quantity.
         */
        function generateQuantity() {
            // 15% chance for a drug to be unavailable (qty 0)
            if (Math.random() < 0.15) {
                return 0;
            }
            return Math.floor(Math.random() * 10) + 1;
        }

        /**
         * Generates random price for a drug based on its base price and current location,
         * with an optional influence from a rumor for prediction purposes.
         * @param {number} basePrice - The base price of the drug.
         * @param {string} location - The current location.
         * @param {string} drugName - The name of the drug being priced.
         * @param {boolean} isPrediction - True if generating a predicted price, false for current market price.
         * @param {object} [rumor] - Optional rumor object { drugName: string, type: 'increase'|'decrease', isTrue: boolean }.
         * @returns {number} - The generated price.
         */
        function generatePrice(basePrice, location, drugName, isPrediction = false, rumor = null) {
            let variance = 0.4;
            const highValueDrugs = ['Cocaine', 'Crack', 'Heroin', 'Ecstacy'];
            if (highValueDrugs.includes(drugName)) {
                variance = 0.7;
            }

            if (location.includes('China') || location.includes('Russia')) {
                variance = Math.max(variance, 0.5);
            }

            let minPrice = basePrice * (1 - variance);
            let maxPrice = basePrice * (1 + variance);

            // Apply rumor influence if generating a prediction and a rumor exists for this drug
            if (isPrediction && rumor && rumor.drugName === drugName) {
                const rumorEffect = 0.15; // 15% potential shift due to rumor
                if (rumor.isTrue) {
                    if (rumor.type === 'increase') {
                        minPrice = basePrice * (1 + rumorEffect);
                        maxPrice = basePrice * (1 + variance + rumorEffect);
                    } else { // rumor.type === 'decrease'
                        maxPrice = basePrice * (1 - rumorEffect);
                        minPrice = basePrice * (1 - variance - rumorEffect);
                    }
                } else { // Rumor is false, price moves opposite
                    if (rumor.type === 'increase') { // Rumor says increase, but it's false, so price decreases
                        maxPrice = basePrice * (1 - rumorEffect);
                        minPrice = basePrice * (1 - variance - rumorEffect);
                    } else { // Rumor says decrease, but it's false, so price increases
                        minPrice = basePrice * (1 + rumorEffect);
                        maxPrice = basePrice * (1 + variance + rumorEffect);
                    }
                }
            }
            
            // Ensure prices don't go below 1
            minPrice = Math.max(1, minPrice);
            maxPrice = Math.max(1, maxPrice);

            return Math.round(minPrice + Math.random() * (maxPrice - minPrice));
        }


        /**
         * Updates the market prices and quantities for the current location,
         * and predicts the trend for the next day.
         */
        function updateMarket() {
            marketPrices = {};
            drugs.forEach(drug => {
                // Current day's price (no rumor influence for current price)
                const currentPrice = generatePrice(drug.basePrice, player.location, drug.name, false, null);
                
                // Find if there's an active rumor for this drug for next day's prediction
                const rumorForDrug = activeRumors.find(r => r.drugName === drug.name);

                // Predict the next day's price, influenced by rumor if present
                const predictedNextDayPrice = generatePrice(drug.basePrice, player.location, drug.name, true, rumorForDrug); 
                
                // Determine trend based on current price vs predicted next day price
                let trend = 'neutral';
                if (predictedNextDayPrice > currentPrice) {
                    trend = 'up';
                } else if (predictedNextDayPrice < currentPrice) {
                    trend = 'down';
                }

                marketPrices[drug.name] = {
                    price: currentPrice,
                    qty: generateQuantity(), // Use the updated generateQuantity
                    predictedNextDayPrice: predictedNextDayPrice, // Store the predicted price
                    trend: trend // Store the predicted trend for the next day
                };
            });
            renderMarketTable();
        }

        /**
         * Generates and displays rumors about market supply and demand.
         * 68% chance of being true, 32% chance of being false.
         */
        function generateRumors() {
            activeRumors = []; // Clear previous rumors

            // Decide how many drugs will have rumors (0, 1, or 2)
            const numRumors = Math.floor(Math.random() * 3); // 0, 1, or 2

            if (numRumors === 0) {
                displayInfo("The market is quiet today. No new rumors circulating.");
                return;
            }

            const shuffledDrugs = [...drugs].
            sort(() => 0.5 - Math.random()); // Shuffle drugs
            
            for (let i = 0; i < numRumors; i++) {
                if (i >= shuffledDrugs.length) break; // Ensure we don't go out of bounds

                const drug = shuffledDrugs[i];
                const rumorType = Math.random() < 0.5 ? 'increase' : 'decrease'; // 50/50 chance for increase/decrease
                const isRumorTrue = Math.random() < 0.68; // 68% true, 32% false

                activeRumors.push({
                    drugName: drug.name,
                    type: rumorType,
                    isTrue: isRumorTrue
                });

                let rumorMessage = `Rumor: Whispers about ${drug.name} are that prices will `;
                rumorMessage += rumorType === 'increase' ? 'rise sharply' : 'fall drastically';
                rumorMessage += `.`;
                displayInfo(rumorMessage, true); // Pass true for isRumor
            }
        }


        /**
         * Renders the market table with current drug prices and quantities, using SVG for trends.
         */
        function renderMarketTable() {
            marketTableBody.innerHTML = '';
            for (const drugName in marketPrices) {
                const drugData = marketPrices[drugName];
                // Only render if quantity > 0, unless explicitly told to show all
                if (drugData.qty > 0) {
                    const row = marketTableBody.insertRow();
                    row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                    row.setAttribute('data-drug-name', drugName);

                    let trendIconHtml = '';
                    if (drugData.trend === 'up') {
                        trendIconHtml = svgUpArrow;
                    } else if (drugData.trend === 'down') {
                        trendIconHtml = svgDownArrow;
                    }

                    row.innerHTML = `
                        <td>${trendIconHtml}</td>
                        <td>${drugName}</td>
                        <td>${drugData.qty}</td>
                        <td>$${drugData.price.toLocaleString()}</td>
                    `;
                    row.onclick = () => selectMarketDrug(drugName);
                    row.ondblclick = async () => {
                        selectMarketDrug(drugName);
                        await buyBtn.onclick();
                    };
                }
            }
            if (selectedMarketDrug && (!marketPrices[selectedMarketDrug.name] || marketPrices[selectedMarketDrug.name].qty === 0)) {
                selectedMarketDrug = null;
            }
            updateTradeButtons();
        }

        /**
         * Selects a drug in the market table.
         * @param {string} drugName - The name of the selected drug.
         */
        function selectMarketDrug(drugName) {
            selectedMarketDrug = { name: drugName, ...marketPrices[drugName] };
            Array.from(marketTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            tradeQuantityInput.value = '';
            updateTradeButtons();
        }

        /**
         * Renders the player's inventory table.
         */
        function renderInventoryTable() {
            inventoryTableBody.innerHTML = '';
            let totalInventoryItems = 0;
            player.inventory.forEach(item => {
                totalInventoryItems++;
                const row = inventoryTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>$${item.purchasePrice.toLocaleString()}</td>
                `;
                row.onclick = () => selectInventoryDrug(item.name);
                row.ondblclick = async () => {
                    selectInventoryDrug(item.name);
                    await sellBtn.onclick();
                };
            });
            inventoryCount.textContent = totalInventoryItems;
            inventoryLimit.textContent = player.inventoryLimit;

            if (selectedInventoryDrug && !player.inventory.some(item => item.name === selectedInventoryDrug.name)) {
                selectedInventoryDrug = null;
            }
            updateTradeButtons();
        }

        /**
         * Selects a drug in the inventory table.
         * @param {string} drugName - The name of the selected drug.
         */
        function selectInventoryDrug(drugName) {
            selectedInventoryDrug = player.inventory.find(item => item.name === drugName);
            Array.from(inventoryTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            tradeQuantityInput.value = '';
            updateTradeButtons();
        }

        /**
         * Updates the status panel with current player stats.
         */
        function updateStatus() {
            statusLocation.textContent = player.location;
            statusHealth.textContent = player.health;
            statusDay.textContent = player.day;
            statusCash.textContent = `$${player.cash.toLocaleString()}`;
            statusBank.textContent = `$${player.bank.toLocaleString()}`;
            statusDebt.textContent = `$${player.debt.toLocaleString()}`;
            if (player.debt <= 0 && player.cash >= 100000) {
                statusRank.textContent = 'Drug Lord';
            } else if (player.debt <= 0) {
                statusRank.textContent = 'Free Man';
            } else if (player.debt > 0 && player.cash < 500) {
                statusRank.textContent = 'Broke Dealer';
            } else {
                statusRank.textContent = 'Newbie';
            }
        }

        /**
         * Displays a message in the information panel.
         * @param {string} message - The message to display.
         * @param {boolean} isRumor - True if the message is a rumor, false otherwise.
         */
        function displayInfo(message, isRumor = false) {
            const infoDisplay = document.getElementById('info-display');
            let formattedMessage = message;

            if (isRumor) {
                formattedMessage = `<span class="rumor-text">${message}</span>`;
            }

            // Prepend new message to existing content
            infoDisplay.innerHTML = formattedMessage + '<br><br>' + infoDisplay.innerHTML;
            infoDisplay.scrollTop = 0; // Scroll to top to show new message
        }

        /**
         * Handles buying drugs from the market.
         */
        buyBtn.onclick = async () => {
            if (!selectedMarketDrug) {
                showMessageBox("Please select a drug to buy.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const drugToBuy = selectedMarketDrug;
            const currentMarketPrice = drugToBuy.price;

            const maxAffordableQuantity = Math.floor(player.cash / currentMarketPrice);
            const maxAvailableQuantity = drugToBuy.qty;

            const maxBuyQuantity = Math.min(maxAffordableQuantity, maxAvailableQuantity);

            if (maxBuyQuantity === 0) { // Check if drug is unavailable
                showMessageBox(`There are no units of ${drugToBuy.name} available in the market or you cannot afford it.`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            buyDrugModalTitle.textContent = `Buying ${drugToBuy.name}`;
            buyDrugModalMessage.innerHTML = `
                ${drugToBuy.name} is currently selling for $${currentMarketPrice.toLocaleString()} per unit.<br>
                With your available funds, you can buy ${maxBuyQuantity} units.
            `;
            buyDrugQuantityInput.value = maxBuyQuantity;
            buyDrugQuantityInput.max = maxBuyQuantity;
            buyDrugModal.style.display = 'flex';

            buyDrugModalOkBtn.onclick = null;
            buyDrugModalCancelBtn.onclick = null;

            buyDrugModalOkBtn.onclick = async () => {
                const quantity = parseInt(buyDrugQuantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    showMessageBox("Please enter a valid quantity to buy.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > maxBuyQuantity) {
                    showMessageBox(`You can only buy up to ${maxBuyQuantity} units of ${drugToBuy.name}.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                const totalCost = quantity * currentMarketPrice;

                const existingDrugIndex = player.inventory.findIndex(item => item.name === drugToBuy.name);
                if (existingDrugIndex === -1 && player.inventory.length >= player.inventoryLimit) {
                    showMessageBox(`Your pants pocket is full! You can only carry ${player.inventoryLimit} types of drugs.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                player.cash -= totalCost;
                if (existingDrugIndex !== -1) {
                    player.inventory[existingDrugIndex].qty += quantity;
                } else {
                    player.inventory.push({
                        name: drugToBuy.name,
                        qty: quantity,
                        purchasePrice: currentMarketPrice
                    });
                }
                marketPrices[drugToBuy.name].qty -= quantity;

                displayInfo(`Bought ${quantity} units of ${drugToBuy.name} for $${totalCost.toLocaleString()}.`);
                playSound('buy_item');
                buyDrugModal.style.display = 'none';
                updateUI();
                saveGameState();
            };

            buyDrugModalCancelBtn.onclick = () => {
                buyDrugModal.style.display = 'none';
            };
        };

        /**
         * Handles selling drugs from inventory.
         */
        sellBtn.onclick = async () => {
            if (!selectedInventoryDrug) {
                showMessageBox("Please select a drug from your inventory to sell.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const drugToSell = selectedInventoryDrug;
            const currentMarketPrice = marketPrices[drugToSell.name] ? marketPrices[drugToSell.name].price : 0;
            const profitPerUnit = currentMarketPrice - drugToSell.purchasePrice;
            const profitLossText = profitPerUnit >= 0 ? `profit of $${profitPerUnit.toLocaleString()}` : `loss of $${Math.abs(profitPerUnit).toLocaleString()}`;


            sellDrugModalTitle.textContent = `Selling ${drugToSell.name}`;
            sellDrugModalMessage.innerHTML = `
                ${drugToSell.name} is currently being bought for $${currentMarketPrice.toLocaleString()} per unit.<br>
                You have ${drugToSell.qty} units to sell for a ${profitLossText} per unit.
            `;
            sellDrugQuantityInput.value = drugToSell.qty;
            sellDrugQuantityInput.max = drugToSell.qty;
            sellDrugModal.style.display = 'flex';

            sellDrugModalOkBtn.onclick = null;
            sellDrugModalCancelBtn.onclick = null;

            sellDrugModalOkBtn.onclick = async () => {
                const quantity = parseInt(sellDrugQuantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    showMessageBox("Please enter a valid quantity to sell.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > drugToSell.qty) {
                    showMessageBox(`You only have ${drugToSell.qty} units of ${drugToSell.name}.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                const currentMarketPrice = marketPrices[drugToSell.name] ? marketPrices[drugToSell.name].price : 0;
                const totalRevenue = quantity * currentMarketPrice;
                const profit = totalRevenue - (quantity * drugToSell.purchasePrice);

                player.cash += totalRevenue;
                drugToSell.qty -= quantity;

                if (drugToSell.qty === 0) {
                    player.inventory = player.inventory.filter(item => item.name !== drugToSell.name);
                    selectedInventoryDrug = null;
                }

                displayInfo(`Sold ${quantity} units of ${drugToSell.name} for $${totalRevenue.toLocaleString()}. Profit: $${profit.toLocaleString()}.`);
                playSound('buy_item');
                sellDrugModal.style.display = 'none';
                updateUI();
                saveGameState();
            };

            sellDrugModalCancelBtn.onclick = () => {
                sellDrugModal.style.display = 'none';
            };
        };


        /**
         * Handles dumping drugs from inventory.
         */
        dumpBtn.onclick = async () => {
            if (!selectedInventoryDrug) {
                showMessageBox("Please select a drug from your inventory to dump.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const drugToDump = selectedInventoryDrug;

            dumpDrugModalTitle.textContent = `Dumping ${drugToDump.name}`;
            dumpDrugModalMessage.innerHTML = `You have ${drugToDump.qty} units of ${drugToDump.name}.`;
            dumpDrugQuantityInput.value = drugToDump.qty;
            dumpDrugQuantityInput.max = drugToDump.qty;
            dumpDrugModal.style.display = 'flex';

            dumpDrugModalOkBtn.onclick = null;
            dumpDrugModalCancelBtn.onclick = null;

            dumpDrugModalOkBtn.onclick = async () => {
                const quantity = parseInt(dumpDrugQuantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    showMessageBox("Please enter a valid quantity to dump.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > drugToDump.qty) {
                    showMessageBox(`You only have ${drugToDump.qty} units of ${drugToDump.name}.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                drugToDump.qty -= quantity;
                if (drugToDump.qty === 0) {
                    player.inventory = player.inventory.filter(item => item.name !== drugToDump.name);
                    selectedInventoryDrug = null;
                }

                displayInfo(`Dumped ${quantity} units of ${drugToDump.name}.`);
                playSound('dump');
                dumpDrugModal.style.display = 'none';
                updateUI();
                saveGameState();
            };

            dumpDrugModalCancelBtn.onclick = () => {
                dumpDrugModal.style.display = 'none';
            };
        };

        /**
         * Handles "Stay Here" action, advancing the day.
         */
        stayHereBtn.onclick = () => {
            advanceDay();
            displayInfo(`You stayed in ${player.location}. A new day begins.`);
            playSound('day_advance');
            saveGameState();
        };

        /**
         * Handles "Fly Away" action, showing the places modal.
         */
        flyAwayBtn.onclick = () => {
            renderPlacesTable();
            placesModal.style.display = 'flex';
        };

        /**
         * Renders the places table in the travel modal.
         */
        function renderPlacesTable() {
            placesTableBody.innerHTML = '';
            cities.forEach(city => {
                const row = placesTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-city-name', city.name);
                row.innerHTML = `
                    <td>${city.name}</td>
                    <td>$${city.travelCost.toLocaleString()}</td>
                `;
                row.onclick = () => selectTravelCity(city.name);
                row.ondblclick = async () => { // Add double-click listener
                    selectTravelCity(city.name);
                    await travelBtn.onclick(); // Trigger the travel action
                };
            });
            updateTravelButton();
        }

        /**
         * Selects a city in the places modal.
         * @param {string} cityName - The name of the selected city.
         */
        function selectTravelCity(cityName) {
            selectedTravelCity = cities.find(city => city.name === cityName);
            Array.from(placesTableBody.rows).forEach(row => {
                if (row.getAttribute('data-city-name') === cityName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            updateTravelButton();
        }

        /**
         * Completes the travel action: deducts cost, changes location, advances day, and updates UI.
         * @param {object} cityToTravel - The city object to travel to.
         */
        function completeTravel(cityToTravel) {
            player.cash -= cityToTravel.travelCost;
            player.location = cityToTravel.name;
            placesModal.style.display = 'none';
            selectedTravelCity = null;
            pendingTravelCity = null; // Clear pending travel
            advanceDay();
            displayInfo(`You traveled to ${player.location} for $${cityToTravel.travelCost.toLocaleString()}. A new day begins.`);
            playSound('fly_away');
            updateUI();
            saveGameState();
        }

        /**
         * Handles traveling to a new city.
         */
        travelBtn.onclick = async () => {
            const cityToTravel = selectedTravelCity;

            if (!cityToTravel) {
                showMessageBox("Please select a city to travel to.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (cityToTravel.name === player.location) {
                showMessageBox("You are already in this city.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (player.cash < cityToTravel.travelCost) {
                showMessageBox("You don't have enough cash to travel there!", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const totalDrugUnitsInInventory = player.inventory.reduce((sum, drug) => sum + drug.qty, 0);
            const noScentCan = player.items.find(item => item.name === 'Can of No-Scent');
            const cansOwned = noScentCan ? noScentCan.qty : 0;
            const hidingCapacityPerCan = storeItems.find(item => item.name === 'Can of No-Scent').hidingCapacity;
            const totalHidingCapacity = cansOwned * hidingCapacityPerCan;

            if (totalDrugUnitsInInventory > 0) {
                const cansNeeded = Math.ceil(totalDrugUnitsInInventory / hidingCapacityPerCan);
                usingNoScentMessage.innerHTML = `To make your drugs undetectable to the drug-sniffing dogs, you will need to use ${cansNeeded} can(s) of No-Scent. You have ${cansOwned} cans. Even though you don't have enough, the more that you do use, the better.`;
                noScentQuantityInput.value = Math.min(cansNeeded, cansOwned);
                noScentQuantityInput.max = cansOwned;
                usingNoScentModal.style.display = 'flex';

                noScentModalOkBtn.onclick = async () => {
                    const cansToUse = parseInt(noScentQuantityInput.value);
                    if (isNaN(cansToUse) || cansToUse < 0 || cansToUse > cansOwned) {
                        showMessageBox("Please enter a valid quantity of cans to use.", [{text: 'OK', value: 'ok'}]);
                        return;
                    }

                    usingNoScentModal.style.display = 'none';

                    if (noScentCan) {
                        noScentCan.qty -= cansToUse;
                        if (noScentCan.qty === 0) {
                            player.items = player.items.filter(item => item.name !== 'Can of No-Scent');
                        }
                    }

                    const effectiveHidingCapacity = cansToUse * hidingCapacityPerCan;
                    let detectionChance = 0;

                    if (totalDrugUnitsInInventory > effectiveHidingCapacity) {
                        detectionChance = (totalDrugUnitsInInventory - effectiveHidingCapacity) / totalHidingCapacity; // Corrected calculation
                        detectionChance = Math.min(detectionChance, 0.8);
                    }

                    const caughtByPolice = Math.random() < detectionChance;

                    if (caughtByPolice) {
                        displayInfo("You were caught by airport security!");
                        pendingTravelCity = cityToTravel; // Store city for later
                        await startAirportSecurityEncounter();
                        return;
                    } else {
                        displayInfo("You successfully avoided detection at the airport!");
                    }

                    // Proceed with travel if not caught
                    completeTravel(cityToTravel);
                };

                noScentModalCancelBtn.onclick = () => {
                    usingNoScentModal.style.display = 'none';
                    showMessageBox("Travel cancelled.", [{text: 'OK', value: 'ok'}]);
                };
            } else {
                // No drugs in inventory, proceed with travel directly
                completeTravel(cityToTravel);
            }
        };

        placesModalCloseBtn.onclick = () => {
            placesModal.style.display = 'none';
            selectedTravelCity = null;
        };

        /**
         * Initiates the airport security encounter.
         */
        async function startAirportSecurityEncounter() {
            airportSecurity.initialEnemies = Math.floor(Math.random() * 20) + 10;
            airportSecurity.enemiesLeft = airportSecurity.initialEnemies;
            airportSecurity.playerWeapon = null;

            airportSecurityModal.style.display = 'flex';
            airportSecurityModalCloseBtn.classList.add('hidden'); // Ensure close button is hidden at start
            
            // Set initial dynamic text
            initialSecurityCount.textContent = airportSecurity.initialEnemies;
            airportSecurityInfo.innerHTML = `You have encountered airport security! There are ${airportSecurity.initialEnemies} of them!`; // Reset fight log
            
            updateAirportSecurityUI();
        }

        /**
         * Appends a message to the airport security info log.
         * @param {string} message - The message to append.
         */
        function appendAirportSecurityLog(message) {
            airportSecurityInfo.innerHTML = message + '<br>' + airportSecurityInfo.innerHTML;
            airportSecurityInfo.scrollTop = 0; // Scroll to top
        }

        /**
         * Renders the player's weapons and ammo in the security modal.
         */
        function renderSecurityWeaponTable() {
            securityWeaponTableBody.innerHTML = '';
            const weapons = player.items.filter(item => item.type === 'Weapon' || item.isExplosive);
            
            if (weapons.length === 0) {
                const row = securityWeaponTableBody.insertRow();
                row.innerHTML = `<td colspan="2" class="text-center py-2">No weapons available.</td>`;
                fightBtn.disabled = true;
                return;
            }

            weapons.sort((a, b) => {
                const aItem = storeItems.find(si => si.name === a.name);
                const bItem = storeItems.find(si => si.name === b.name);
                return (bItem?.damage || 0) - (aItem?.damage || 0);
            });

            weapons.forEach(weapon => {
                const weaponDetails = storeItems.find(item => item.name === weapon.name);
                let ammoQty = 0;
                if (weaponDetails && weaponDetails.ammoType) {
                    const ammo = player.items.find(item => item.name === weaponDetails.ammoType);
                    ammoQty = ammo ? ammo.qty : 0;
                } else if (weaponDetails && weaponDetails.isExplosive) {
                    ammoQty = weapon.qty;
                }

                const row = securityWeaponTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-weapon-name', weapon.name);
                row.innerHTML = `
                    <td>${weapon.name}</td>
                    <td>${ammoQty}</td>
                `;
                row.onclick = () => selectSecurityWeapon(weapon.name);

                if (airportSecurity.playerWeapon && airportSecurity.playerWeapon.name === weapon.name) {
                    row.classList.add('bg-blue-800');
                }
            });
        }

        /**
         * Selects a weapon in the airport security modal.
         * @param {string} weaponName - The name of the selected weapon.
         */
        function selectSecurityWeapon(weaponName) {
            airportSecurity.playerWeapon = player.items.find(item => item.name === weaponName);
            Array.from(securityWeaponTableBody.rows).forEach(row => {
                if (row.getAttribute('data-weapon-name') === weaponName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            updateAirportSecurityUI();
        }

        surrenderBtn.onclick = async () => {
            const confirm = await showMessageBox("Are you sure you want to surrender? All your money and items will be confiscated, and you will go to jail.", [{text: 'Yes', value: true}, {text: 'No', value: false}]);
            if (confirm) {
                player.cash = 0;
                player.bank = 0;
                player.inventory = [];
                player.items = [];
                appendAirportSecurityLog("You surrendered to airport security. All your money and items were confiscated.");
                airportSecurityModal.style.display = 'none';
                placesModal.style.display = 'none'; // Close places modal
                pendingTravelCity = null; // Clear pending travel on surrender
                gameOver("You went to jail. Game Over!");
            }
        };

        runBtn.onclick = async () => {
            playSound('run');
            const escapeChance = 0.4;
            if (Math.random() < escapeChance) {
                appendAirportSecurityLog("You successfully ran away from airport security!");
                airportSecurityModal.style.display = 'none';
                placesModal.style.display = 'none'; // Close places modal
                pendingTravelCity = null; // Clear pending travel on escape
                updateUI();
                saveGameState();
            } else {
                appendAirportSecurityLog("You failed to escape! Airport security is still after you.");
                const healthLost = 5;
                player.health = Math.max(0, player.health - healthLost);
                playSound('health_decline'); // Play sound on health decline
                await showMessageBox(`Your health decreased by ${healthLost} due to failing to escape! Current health: ${player.health}`, [{text: 'OK', value: 'ok'}]);
                updateAirportSecurityUI();
                if (player.health <= 0) {
                    gameOver("Your health dropped to zero trying to escape. Game Over!");
                    airportSecurityModal.style.display = 'none';
                    placesModal.style.display = 'none'; // Close places modal
                    pendingTravelCity = null; // Clear pending travel on game over
                }
            }
        };

        bribeBtn.onclick = async () => {
            const bribeAmount = Math.floor(Math.random() * 1000) + 500;
            const confirm = await showMessageBox(`Airport security demands a bribe of $${bribeAmount.toLocaleString()}. Do you accept?`, [{text: 'Yes', value: true}, {text: 'No', value: false}]);
            if (confirm) {
                if (player.cash >= bribeAmount) {
                    player.cash -= bribeAmount;
                    appendAirportSecurityLog(`You successfully bribed airport security for $${bribeAmount.toLocaleString()}.`);
                    airportSecurityModal.style.display = 'none';
                    // After successful bribe, complete the original travel action
                    if (pendingTravelCity) {
                        completeTravel(pendingTravelCity);
                    } else {
                        placesModal.style.display = 'none'; // Close places modal
                        updateUI();
                        saveGameState();
                    }
                } else {
                    appendAirportSecurityLog("You don't have enough cash to pay the bribe! They are still coming for you.");
                }
            }
        };

        fightBtn.onclick = async () => {
            if (!airportSecurity.playerWeapon) {
                showMessageBox("Please select a weapon to fight.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const weaponDetails = storeItems.find(item => item.name === airportSecurity.playerWeapon.name);
            if (!weaponDetails) {
                showMessageBox("Invalid weapon selected.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            let ammoAvailable = 0;
            if (weaponDetails.ammoType) {
                const ammoItem = player.items.find(item => item.name === weaponDetails.ammoType);
                ammoAvailable = ammoItem ? ammoItem.qty : 0;
            } else if (weaponDetails.isExplosive) {
                ammoAvailable = airportSecurity.playerWeapon.qty;
            }

            if (ammoAvailable === 0 && (weaponDetails.ammoType || weaponDetails.isExplosive)) {
                showMessageBox(`You are out of ${weaponDetails.ammoType || weaponDetails.name}!`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            const damageDealt = weaponDetails.damage;
            airportSecurity.enemiesLeft = Math.max(0, airportSecurity.enemiesLeft - damageDealt);
            appendAirportSecurityLog(`You attacked with ${weaponDetails.name}, dealing ${damageDealt} damage. ${airportSecurity.enemiesLeft} security left.`);

            if (weaponDetails.ammoType) {
                const ammoItem = player.items.find(item => item.name === weaponDetails.ammoType);
                if (ammoItem) {
                    ammoItem.qty--;
                    if (ammoItem.qty === 0) {
                        player.items = player.items.filter(item => item.name !== ammoItem.name);
                    }
                }
            } else if (weaponDetails.isExplosive) {
                airportSecurity.playerWeapon.qty--;
                if (airportSecurity.playerWeapon.qty === 0) {
                    player.items = player.items.filter(item => item.name !== airportSecurity.playerWeapon.name);
                    airportSecurity.playerWeapon = null;
                }
            }

            if (airportSecurity.enemiesLeft <= 0) {
                appendAirportSecurityLog("You defeated airport security! You are free to go.");
                airportSecurityModalCloseBtn.classList.remove('hidden'); // Show close button
                surrenderBtn.disabled = true; // Disable actions when fight is over
                runBtn.disabled = true;
                bribeBtn.disabled = true;
                fightBtn.disabled = true;
                updateAirportSecurityUI(); // Update to show 0 enemies left
                
                // After defeating security, complete the original travel action
                if (pendingTravelCity) {
                    completeTravel(pendingTravelCity);
                } else {
                    placesModal.style.display = 'none'; // Close places modal if it was open but no pending travel
                    updateUI();
                    saveGameState();
                }
                return;
            }

            const securityDamage = Math.floor(Math.random() * 10) + 5;
            player.health = Math.max(0, player.health - securityDamage);
            playSound('health_decline'); // Play sound on health decline
            await showMessageBox(`Your health decreased by ${securityDamage} due to airport security attack! Current health: ${player.health}`, [{text: 'OK', value: 'ok'}]);
            appendAirportSecurityLog(`Airport security attacked, dealing ${securityDamage} damage. Your health is now ${player.health}.`);

            if (player.health <= 0) {
                gameOver("Your health dropped to zero during the airport security encounter. You're out of the game!");
                airportSecurityModal.style.display = 'none';
                placesModal.style.display = 'none'; // Close places modal
                pendingTravelCity = null; // Clear pending travel on game over
                return;
            }

            updateAirportSecurityUI();
            saveGameState();
        };

        airportSecurityModalCloseBtn.onclick = () => {
            airportSecurityModal.style.display = 'none';
            // If pendingTravelCity is still set, it means travel was interrupted but not completed (e.g., ran away, closed modal manually)
            // In this case, we close places modal and don't complete travel if it wasn't already handled by bribe/fight success
            if (pendingTravelCity) {
                showMessageBox("Travel to previous destination cancelled.", [{text: 'OK', value: 'ok'}]);
                pendingTravelCity = null; // Clear pending travel
            }
            placesModal.style.display = 'none'; // Ensure places modal is closed
            updateUI(); // Ensure UI updates and main game is enabled
        };


        /**
         * Advances the game to the next day.
         * Handles debt interest, health changes, market updates, and shipments.
         */
        async function advanceDay() {
            player.day++;

            for (const loan of player.loans) {
                if (loan.currentDebt > 0) {
                    const interest = Math.round(loan.currentDebt * loan.rate);
                    loan.currentDebt += interest;
                    displayInfo(`${loan.name} charges you $${interest.toLocaleString()} interest. Your debt to them is now $${loan.currentDebt.toLocaleString()}.`);
                }
                loan.daysLeft = Math.max(0, loan.daysLeft - 1);
                if (loan.daysLeft === 0 && loan.currentDebt > 0) {
                    playSound('lender_collect');

                    const canAfford = player.cash >= loan.currentDebt;
                    let buttons = [{ text: 'OK', value: 'ok' }];

                    if (canAfford) {
                        buttons.unshift({ text: 'Pay', value: 'pay', style: 'green' });
                    }

                    const userChoice = await showMessageBox(`ALERT! Your loan with ${loan.name} for $${loan.currentDebt.toLocaleString()} is due today!`, buttons);

                    if (userChoice === 'pay') {
                        player.cash -= loan.currentDebt;
                        player.debt -= loan.currentDebt;
                        loan.currentDebt = 0;
                        displayInfo(`You repaid $${loan.currentDebt.toLocaleString()} to ${loan.name}. The loan is cleared.`);
                        playSound('loan_repay'); // Play sound on successful loan repayment
                    } else {
                        displayInfo(`WARNING: Your loan with ${loan.name} is overdue! Expect trouble.`);
                        const healthPenalty = 20;
                        player.health = Math.max(0, player.health - healthPenalty);
                        playSound('health_decline'); // Play sound on health decline
                        await showMessageBox(`Your health decreased by ${healthPenalty} due to overdue loan from ${loan.name}! Current health: ${player.health}`, [{ text: 'OK', value: 'ok'}]);
                    }
                }
            }
            player.debt = player.loans.reduce((sum, loan) => sum + loan.currentDebt, 0);

            player.shipments = player.shipments.filter(shipment => {
                if (shipment.arrivalDay <= player.day) {
                    const existingDrugIndex = player.inventory.findIndex(item => item.name === shipment.drugName);
                    if (existingDrugIndex !== -1) {
                        player.inventory[existingDrugIndex].qty += shipment.qty;
                    } else {
                        player.inventory.push({
                            name: shipment.drugName,
                            qty: shipment.qty,
                            purchasePrice: shipment.purchasePrice
                        });
                    }
                    displayInfo(`Your shipment of ${shipment.qty} units of ${shipment.drugName} has arrived in ${shipment.destination}!`);
                    playSound('shipment_arrive');
                    return false;
                }
                return true;
            });


            const randomEvent = Math.random();
            if (randomEvent < 0.1) {
                const eventType = Math.random();
                if (eventType < 0.5) {
                    const cashBonus = Math.floor(Math.random() * 500) + 100;
                    player.cash += cashBonus;
                    displayInfo(`You found $${cashBonus.toLocaleString()} on the street!`);
                } else {
                    player.health = Math.min(100, player.health + 10);
                    displayInfo(`You had a good night's sleep. Health increased by 10.`);
                }
            } else if (randomEvent > 0.9) {
                const eventType = Math.random();
                if (eventType < 0.5) {
                    const fine = Math.floor(Math.random() * 1000) + 200;
                    player.cash -= fine;
                    if (player.cash < 0) player.cash = 0;
                    displayInfo(`You were caught loitering and fined $${fine.toLocaleString()}!`);
                    playSound('robbed'); // Play sound when fined (losing money)
                } else {
                    const healthLost = 15;
                    player.health = Math.max(0, player.health - healthLost);
                    playSound('health_decline'); // Play sound on health decline
                    await showMessageBox(`Your health decreased by ${healthLost} due to a street fight! Current health: ${player.health}`, [{text: 'OK', value: 'ok'}]);
                    displayInfo(`You got into a street fight. Health decreased by 15.`);
                    playSound('robbed'); // Play sound when health is lost due to a fight (implying a form of robbery/attack)
                }
            }

            if (player.health <= 0) {
                gameOver("Your health dropped to zero. You're out of the game!");
                return;
            }
            if (player.day > 30) {
                gameOver("30 days have passed! Let's see how you did.");
                return;
            }

            generateRumors(); // Generate rumors for the new day
            updateMarket();
            updateUI();
        }

        /**
         * Contains the core logic for resetting the game state and UI.
         * This function should only be called when explicitly starting a new game.
         */
        function resetGameAndStart() {
            player = {
                cash: 10000,
                bank: 0,
                debt: 1000,
                health: 100,
                day: 1,
                location: 'Austin, USA',
                inventory: [],
                inventoryLimit: 10,
                items: [],
                loans: [{ name: 'Buddles', rate: 0.07 * 0.80, days: 6, currentDebt: 1000, daysLeft: 6, maxLoan: 0 }],
                vault: [],
                shipments: [],
            };
            infoDisplay.innerHTML = "Welcome to Drug Lord! Your goal is to make as much money as possible by buying and selling drugs. You start with $10000 cash and a $1000 debt to Buddles, a loan shark. Pay him back quickly, or face the consequences! Travel between cities to find the best prices. Good luck!";
            activeRumors = []; // Reset rumors on new game
            pendingTravelCity = null; // Clear pending travel on new game
            updateMarket(); // Populate market for new game
            updateUI(); // Update all UI components for active game
            enableGameUIButtons(); // Enable buttons for gameplay
            saveGameState();
        }
        
        /**
         * Ends the game and shows final score.
         * @param {string} message - The game over message.
         */
        async function gameOver(message) {
            playSound('end_game');
            const finalScore = player.cash + player.bank - player.debt;
            const fullMessage = `${message}\n\nGame Over!\nFinal Score: $${finalScore.toLocaleString()}\n\nStart a New Game?`;
            
            const userClickedOk = await showMessageBox(fullMessage, [{text: 'OK', value: 'ok'}]); 

            if (userClickedOk) {
                resetGameAndStart();
            }
        }

        /**
         * Starts a new game, prompting the user for confirmation.
         * This is typically called by the "New Game" button.
         */
        async function newGame() {
            const confirmNewGame = await showMessageBox("Are you sure you want to start a New Game? All unsaved progress will be lost.", [{text: 'Yes', value: true}, {text: 'No', value: false}]);
            if (confirmNewGame) {
                resetGameAndStart();
            }
        }

        newGameBtn.onclick = newGame;

        quitBtn.onclick = async () => {
            const confirmQuit = await showMessageBox(
                "Are you sure you want to Quit? The game will end, and all your money and items will be confiscated.",
                [{text: 'Yes', value: true}, {text: 'No', value: false}]
            );

            if (confirmQuit) {
                player.cash = 0;
                player.bank = 0;
                player.inventory = [];
                player.items = [];
                displayInfo("You quit the game. All your money and items were confiscated.");
                updateUIForNoGame(); // Go to pre-game state after quitting
            } else {
                displayInfo("Quit cancelled. Returning to game.");
            }
        };

        document.getElementById('about-btn').onclick = () => showMessageBox("Drug Lord Web Game v1.0\nRe-created by your AI assistant.", [{text: 'OK', value: 'ok'}]);
        document.getElementById('docs-btn').onclick = () => showMessageBox("This would link to game documentation or a tutorial.", [{text: 'OK', value: 'ok'}]);
        document.getElementById('high-scores-btn').onclick = () => showMessageBox("High Scores are not implemented in this version. Check back later!", [{text: 'OK', value: 'ok'}]);


        // --- Finances Modal Logic ---
        financesBtn.onclick = () => {
            renderFinancesModal();
            financesModal.style.display = 'flex';
        };

        financesModalCloseBtn.onclick = () => {
            financesModal.style.display = 'none';
            selectedLoan = null;
            updateUI();
        };

        function renderFinancesModal() {
            bankCashDisplay.textContent = `$${player.cash.toLocaleString()}`;
            bankBankDisplay.textContent = `$${player.bank.toLocaleString()}`;
            bankAmountInput.value = '';
            renderLoansTable();
        }

        function renderLoansTable() {
            loansTableBody.innerHTML = '';
            const currentLoanNames = player.loans.map(l => l.name);
            const availableSharks = loanSharks.filter(ls => !currentLoanNames.includes(ls.name));
            const allLoanOptions = [...player.loans, ...availableSharks];


            allLoanOptions.forEach(loan => {
                const row = loansTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-loan-name', loan.name);
                
                const currentDebt = loan.currentDebt !== undefined ? loan.currentDebt : 0;
                const daysLeft = loan.daysLeft !== undefined ? loan.daysLeft : loan.days;
                const maxLoanAmount = loan.maxLoan !== undefined ? `$${loan.maxLoan.toLocaleString()}` : 'N/A';


                row.innerHTML = `
                    <td>${loan.name}</td>
                    <td>${(loan.rate * 100).toFixed(1)}%</td>
                    <td>${daysLeft}</td>
                    <td>$${currentDebt.toLocaleString()}</td>
                    <td>${daysLeft}</td>
                    <td>${maxLoanAmount}</td>
                `;
                row.onclick = () => selectLoan(loan.name);
                row.ondblclick = () => handleLoanSharkDoubleClick(loan.name);
            });
            updateLoanButtons();
        }

        function selectLoan(loanName) {
            selectedLoan = player.loans.find(l => l.name === loanName) || loanSharks.find(l => l.name === loanName);
            Array.from(loansTableBody.rows).forEach(row => {
                if (row.getAttribute('data-loan-name') === loanName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            updateLoanButtons();
        }

        /**
         * Handles double-clicking on a loan shark in the finances modal.
         * Shows a modal to borrow an amount.
         * @param {string} loanName - The name of the loan shark.
         */
        async function handleLoanSharkDoubleClick(loanName) {
            const loanShark = loanSharks.find(ls => ls.name === loanName);
            const existingPlayerLoan = player.loans.find(pl => pl.name === loanName);

            if (!loanShark) {
                showMessageBox("Loan shark not found.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            if (existingPlayerLoan && existingPlayerLoan.currentDebt > 0) {
                showMessageBox(`You already have an outstanding loan with ${loanShark.name}. Repay it first.`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            // Set selectedLoan for the borrow action
            selectedLoan = loanShark;

            borrowAmountModalTitle.textContent = `Borrow from ${loanShark.name}`;
            borrowAmountModalMessage.innerHTML = `
                ${loanShark.name} is offering a maximum loan of $${loanShark.maxLoan.toLocaleString()} at a rate of ${(loanShark.rate * 100).toFixed(1)}%.
                <br>
                How much do you wish to borrow?
            `;
            borrowInputField.value = loanShark.maxLoan;
            borrowInputField.max = loanShark.maxLoan;
            borrowInputField.min = 0;
            
            borrowAmountModal.style.display = 'flex';

            borrowAmountModalOkBtn.onclick = async () => {
                const amount = parseInt(borrowInputField.value);
                
                if (isNaN(amount) || amount <= 0 || amount > loanShark.maxLoan) {
                    borrowAmountModal.style.display = 'none';
                    showMessageBox(`Please enter a valid amount to borrow (max $${loanShark.maxLoan.toLocaleString()}).`, [{text: 'OK', value: 'ok'}]);
                    financesModal.style.display = 'flex'; // Reopen finances modal
                    return;
                }

                player.cash += amount;
                
                if (existingPlayerLoan) { // Update existing loan entry if it exists (but has 0 debt)
                    existingPlayerLoan.currentDebt = amount;
                    existingPlayerLoan.daysLeft = loanShark.days;
                    player.debt += amount;
                } else { // Add new loan entry
                    const newLoanEntry = {
                        name: loanShark.name,
                        rate: loanShark.rate,
                        days: loanShark.days,
                        currentDebt: amount,
                        daysLeft: loanShark.days,
                        maxLoan: loanShark.maxLoan
                    };
                    player.loans.push(newLoanEntry);
                    player.debt += amount;
                }

                displayInfo(`Borrowed $${amount.toLocaleString()} from ${loanShark.name}.`);
                borrowAmountModal.style.display = 'none';
                financesModal.style.display = 'flex'; // Reopen finances modal
                updateUI();
                saveGameState();
            };

            borrowAmountModalCancelBtn.onclick = () => {
                borrowAmountModal.style.display = 'none';
                financesModal.style.display = 'flex'; // Reopen finances modal
            };
        }


        depositBtn.onclick = async () => {
            const amount = parseInt(bankAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                await showMessageBox("Please enter a valid amount to deposit.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            if (player.cash < amount) {
                await showMessageBox("You don't have enough cash to deposit!", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            player.cash -= amount;
            player.bank += amount;
            displayInfo(`Deposited $${amount.toLocaleString()} into your bank account.`);
            renderFinancesModal();
            updateUI();
            saveGameState();
        };

        withdrawBtn.onclick = async () => {
            const amount = parseInt(bankAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                await showMessageBox("Please enter a valid amount to withdraw.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            if (player.bank < amount) {
                await showMessageBox("You don't have enough money in your bank account!", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            player.bank -= amount;
            player.cash += amount;
            displayInfo(`Withdrew $${amount.toLocaleString()} from your bank account.`);
            renderFinancesModal();
            updateUI();
            saveGameState();
        };

        depositAllBtn.onclick = async () => {
            if (player.cash === 0) {
                await showMessageBox("You have no cash to deposit.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            const amount = player.cash;
            player.cash = 0;
            player.bank += amount;
            displayInfo(`Deposited all $${amount.toLocaleString()} into your bank account.`);
            renderFinancesModal();
            updateUI();
            saveGameState();
        };

        withdrawAllBtn.onclick = async () => {
            if (player.bank === 0) {
                await showMessageBox("You have no money in your bank account.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            const amount = player.bank;
            player.bank = 0;
            player.cash += amount;
            displayInfo(`Withdrew all $${amount.toLocaleString()} from your bank account.`);
            renderFinancesModal();
            updateUI();
            saveGameState();
        };

        borrowLoanBtn.onclick = async () => {
            if (!selectedLoan) {
                await showMessageBox("Please select a loan shark to borrow from.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            const amount = parseInt(loanAmountInput.value);
            if (isNaN(amount) || amount <= 0 || amount > selectedLoan.maxLoan) {
                await showMessageBox(`Please enter a valid amount to borrow (max $${selectedLoan.maxLoan.toLocaleString()}).`, [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }

            const existingLoanIndex = player.loans.findIndex(l => l.name === selectedLoan.name);
            if (existingLoanIndex !== -1 && player.loans[existingLoanIndex].currentDebt > 0) {
                 await showMessageBox(`You already have an outstanding loan with ${selectedLoan.name}. Repay it first.`, [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }


            player.cash += amount;
            
            if (existingLoanIndex !== -1) {
                player.loans[existingLoanIndex].currentDebt = amount;
                player.loans[existingLoanIndex].daysLeft = selectedLoan.days;
                player.debt += amount;
            } else {
                const newLoanEntry = {
                    name: selectedLoan.name,
                    rate: selectedLoan.rate,
                    days: selectedLoan.days,
                    currentDebt: amount,
                    daysLeft: selectedLoan.days,
                    maxLoan: selectedLoan.maxLoan
                };
                player.loans.push(newLoanEntry);
                player.debt += amount;
            }


            displayInfo(`Borrowed $${amount.toLocaleString()} from ${selectedLoan.name}.`);
            loanAmountInput.value = '';
            renderFinancesModal();
            updateUI();
            saveGameState();
        };

        repayLoanBtn.onclick = async () => {
            if (!selectedLoan) {
                 await showMessageBox("Please select an outstanding loan to repay.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            const loanToRepay = player.loans.find(l => l.name === selectedLoan.name);
            if(!loanToRepay || loanToRepay.currentDebt <=0){
                await showMessageBox("This loan has no outstanding debt or is not one of your current loans.", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }

            let amount = parseInt(loanAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                const confirmRepayAll = await showMessageBox(`Repay the full amount of $${loanToRepay.currentDebt.toLocaleString()} for ${loanToRepay.name}?`, [{text: 'Yes', value: true}, {text: 'No', value: false}]);
                if (confirmRepayAll) {
                    amount = loanToRepay.currentDebt;
                } else {
                    await showMessageBox("Please enter a valid amount to repay.", [{text: 'OK', value: 'ok'}], () => {
                        financesModal.style.display = 'flex';
                    });
                    return;
                }
            }
            
            if (player.cash < amount) {
                await showMessageBox("You don't have enough cash to repay this amount!", [{text: 'OK', value: 'ok'}], () => {
                    financesModal.style.display = 'flex';
                });
                return;
            }
            if (amount > loanToRepay.currentDebt) {
                const confirmOverpay = await showMessageBox(`You are trying to repay more than your current debt ($${loanToRepay.currentDebt.toLocaleString()}). Repay $${loanToRepay.currentDebt.toLocaleString()} instead?`, [{text: 'Yes', value: true}, {text: 'No', value: false}]);
                if (confirmOverpay) {
                    amount = loanToRepay.currentDebt;
                } else {
                    await showMessageBox("Please enter a valid amount to repay.", [{text: 'OK', value: 'ok'}], () => {
                        financesModal.style.display = 'flex';
                    });
                    return;
                }
            }

            player.cash -= amount;
            player.debt -= amount;
            loanToRepay.currentDebt -= amount;

            if (loanToRepay.currentDebt <= 0) {
                loanToRepay.currentDebt = 0; 
                displayInfo(`Successfully repaid $${amount.toLocaleString()} to ${loanToRepay.name}. The loan is cleared.`);
            } else {
                displayInfo(`Repaid $${amount.toLocaleString()} to ${loanToRepay.name}. Remaining debt: $${loanToRepay.currentDebt.toLocaleString()}.`);
            }
            loanAmountInput.value = '';
            renderFinancesModal();
            updateUI();
            saveGameState();
        };


        // --- Shopping Modal Logic ---
        shoppingBtn.onclick = () => {
            renderShoppingModal();
            shoppingModal.style.display = 'flex';
        };

        shoppingModalCloseBtn.onclick = () => {
            shoppingModal.style.display = 'none';
            selectedStoreItem = null;
            selectedPlayerItem = null;
            updateUI();
        };

        function renderShoppingModal() {
            shopCashDisplay.textContent = `$${player.cash.toLocaleString()}`;
            shopQuantityInput.value = '';
            renderStoreInventoryTable();
            renderPlayerItemInventoryTable();
        }

        function renderStoreInventoryTable() {
            storeInventoryTableBody.innerHTML = '';
            storeItems.forEach(item => {
                const row = storeInventoryTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-item-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>$${item.price.toLocaleString()}</td>
                `;
                row.onclick = () => selectStoreItem(item.name);
                row.ondblclick = () => handleStoreItemDoubleClick(item.name);
            });
            updateShopButtons();
        }

        /**
         * Handles double-clicking on a store item, showing the buy item quantity modal.
         * @param {string} itemName - The name of the item double-clicked.
         */
        async function handleStoreItemDoubleClick(itemName) {
            const itemToBuy = storeItems.find(item => item.name === itemName);
            if (!itemToBuy) return;

            if (itemToBuy.type === 'Weapon') {
                const existingWeapon = player.items.find(playerItem => playerItem.name === itemToBuy.name && playerItem.type === 'Weapon');
                if (existingWeapon) {
                    shoppingModal.style.display = 'none';
                    await showMessageBox(
                        `You already own a ${itemToBuy.name}. You can only carry one of each weapon type.`,
                        [{text: 'OK', value: 'ok'}]
                    );
                    shoppingModal.style.display = 'flex';
                    return;
                }
            }

            showBuyItemQuantityModal(itemToBuy);
        }

        /**
         * Displays the modal for entering quantity when buying an item.
         * @param {object} item - The item object to buy.
         */
        function showBuyItemQuantityModal(item) {
            selectedStoreItem = item;

            buyItemQuantityModalTitle.textContent = `Buying ${item.name}`;
            buyItemQuantityModalMessage.innerHTML = `
                ${item.name} is currently selling for $${item.price.toLocaleString()} per unit.<br>
                Your Cash: $${player.cash.toLocaleString()}
            `;
            
            if (item.type === 'Ammo') {
                buyItemQuantityInput.value = item.units || 10;
                buyItemQuantityInput.max = 9999;
            } else if (item.type === 'Weapon') {
                buyItemQuantityInput.value = 1;
                buyItemQuantityInput.max = 1;
            } else if (item.name === 'Can of No-Scent') {
                const existingNoScent = player.items.find(playerItem => playerItem.name === 'Can of No-Scent');
                const currentCans = existingNoScent ? existingNoScent.qty : 0;
                const maxAllowed = item.inventoryMax - currentCans;
                buyItemQuantityInput.value = Math.min(item.maxPurchase, maxAllowed);
                buyItemQuantityInput.max = Math.min(item.maxPurchase, maxAllowed);
                if (maxAllowed <= 0) {
                    buyItemQuantityModalMessage.innerHTML += `<br><span class="text-red-400">You cannot carry any more ${item.name}.</span>`;
                    buyItemQuantityInput.value = 0;
                    buyItemQuantityInput.max = 0;
                }
            } else {
                buyItemQuantityInput.value = 1;
                buyItemQuantityInput.max = 99;
            }

            buyItemQuantityModal.style.display = 'flex';

            buyItemQuantityModalOkBtn.onclick = null;
            buyItemQuantityModalCancelBtn.onclick = null;

            buyItemQuantityModalOkBtn.onclick = async () => {
                const quantity = parseInt(buyItemQuantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    buyItemQuantityModal.style.display = 'none';
                    await showMessageBox("Please enter a valid quantity to buy.", [{text: 'OK', value: 'ok'}]);
                    shoppingModal.style.display = 'flex';
                    return;
                }

                if (item.type === 'Weapon') {
                    const existingWeapon = player.items.find(playerItem => playerItem.name === item.name && playerItem.type === 'Weapon');
                    if (existingWeapon && quantity > 0) {
                        buyItemQuantityModal.style.display = 'none';
                        await showMessageBox(`You already own a ${item.name}. You can only carry one of each weapon type.`, [{text: 'OK', value: 'ok'}]);
                        shoppingModal.style.display = 'flex';
                        return;
                    }
                    if (quantity > 1) {
                        buyItemQuantityModal.style.display = 'none';
                        await showMessageBox(`You can only buy 1 unit of ${item.name}.`, [{text: 'OK', value: 'ok'}]);
                        shoppingModal.style.display = 'flex';
                        return;
                    }
                }
                
                if (item.name === 'Can of No-Scent') {
                    const existingNoScent = player.items.find(playerItem => playerItem.name === 'Can of No-Scent');
                    const currentCans = existingNoScent ? existingNoScent.qty : 0;
                    if (currentCans + quantity > item.inventoryMax) {
                        buyItemQuantityModal.style.display = 'none';
                        await showMessageBox(`You can only carry a maximum of ${item.inventoryMax} cans of No-Scent. You currently have ${currentCans} and cannot buy ${quantity} more.`, [{text: 'OK', value: 'ok'}]);
                        shoppingModal.style.display = 'flex';
                        return;
                    }
                }

                const totalCost = quantity * item.price;
                if (player.cash < totalCost) {
                    buyItemQuantityModal.style.display = 'none';
                    await showMessageBox("You don't have enough cash!", [{text: 'OK', value: 'ok'}]);
                    shoppingModal.style.display = 'flex';
                    return;
                }

                player.cash -= totalCost;
                const existingItemIndex = player.items.findIndex(playerItem => playerItem.name === item.name);
                if (existingItemIndex !== -1) {
                    player.items[existingItemIndex].qty += quantity;
                } else {
                    player.items.push({
                        name: item.name,
                        type: item.type,
                        qty: quantity,
                        purchasePrice: item.price,
                        sellPrice: item.sellPrice,
                        ...(item.damage && { damage: item.damage }),
                        ...(item.ammoType && { ammoType: item.ammoType }),
                        ...(item.isExplosive && { isExplosive: item.isExplosive }),
                        ...(item.units && { units: item.units }),
                        ...(item.maxPurchase && { maxPurchase: item.maxPurchase }),
                        ...(item.hidingCapacity && { hidingCapacity: item.hidingCapacity }),
                        ...(item.inventoryMax && { inventoryMax: item.inventoryMax }),
                    });
                }
                displayInfo(`Bought ${quantity} units of ${item.name} for $${totalCost.toLocaleString()}.`);
                playSound('buy_item');
                buyItemQuantityModal.style.display = 'none';
                shoppingModal.style.display = 'flex';
                updateUI();
                saveGameState();
            };

            buyItemQuantityModalCancelBtn.onclick = () => {
                buyItemQuantityModal.style.display = 'none';
                shoppingModal.style.display = 'flex';
            };
        }


        function selectStoreItem(itemName) {
            selectedStoreItem = storeItems.find(item => item.name === itemName);
            Array.from(storeInventoryTableBody.rows).forEach(row => {
                if (row.getAttribute('data-item-name') === itemName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            shopQuantityInput.value = '';
            updateShopButtons();
        }

        function renderPlayerItemInventoryTable() {
            playerItemInventoryTableBody.innerHTML = '';
            player.items.forEach(item => {
                const row = playerItemInventoryTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-item-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${item.qty}</td>
                    <td>$${item.purchasePrice.toLocaleString()}</td> `;
                row.onclick = () => selectPlayerItem(item.name);
                row.ondblclick = async () => {
                    selectPlayerItem(item.name);
                    await shopSellBtn.onclick();
                };
            });
            updateShopButtons();
        }

        function selectPlayerItem(itemName) {
            selectedPlayerItem = player.items.find(item => item.name === itemName);
            Array.from(playerItemInventoryTableBody.rows).forEach(row => {
                if (row.getAttribute('data-item-name') === itemName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            shopQuantityInput.value = '';
            updateShopButtons();
        }

        shopBuyBtn.onclick = async () => {
            console.log("Shop Buy button clicked.");
            if (!selectedStoreItem) {
                showMessageBox("Please select an item to buy.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            const quantity = parseInt(shopQuantityInput.value);
            if (isNaN(quantity) || quantity <= 0) {
                showMessageBox("Please enter a valid quantity.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (selectedStoreItem.name === 'Can of No-Scent') {
                const existingNoScent = player.items.find(item => item.name === 'Can of No-Scent');
                const currentCans = existingNoScent ? existingNoScent.qty : 0;
                const maxAllowedToBuy = Math.min(selectedStoreItem.maxPurchase, selectedStoreItem.inventoryMax - currentCans);

                if (quantity > maxAllowedToBuy) {
                    showMessageBox(`You can only buy up to ${maxAllowedToBuy} cans of No-Scent. You currently have ${currentCans} and cannot exceed ${selectedStoreItem.inventoryMax} total.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }
            }

            if (selectedStoreItem.type === 'Weapon') {
                const existingWeapon = player.items.find(playerItem => playerItem.name === selectedStoreItem.name && playerItem.type === 'Weapon');
                if (existingWeapon && quantity > 0) {
                    showMessageBox(`You already own a ${selectedStoreItem.name}. You can only carry one of each weapon type.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > 1) {
                    showMessageBox(`You can only buy 1 unit of ${selectedStoreItem.name}.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }
            }

            const totalCost = quantity * selectedStoreItem.price;
            if (player.cash < totalCost) {
                showMessageBox("You don't have enough cash!", [{text: 'OK', value: 'ok'}]);
                return;
            }

            player.cash -= totalCost;
            const existingItemIndex = player.items.findIndex(item => item.name === selectedStoreItem.name);
            if (existingItemIndex !== -1) {
                player.items[existingItemIndex].qty += quantity;
            } else {
                player.items.push({
                    name: selectedStoreItem.name,
                    type: selectedStoreItem.type,
                    qty: quantity,
                    purchasePrice: selectedStoreItem.price,
                    sellPrice: selectedStoreItem.sellPrice,
                    ...(selectedStoreItem.damage && { damage: selectedStoreItem.damage }),
                    ...(selectedStoreItem.ammoType && { ammoType: selectedStoreItem.ammoType }),
                    ...(selectedStoreItem.isExplosive && { isExplosive: selectedStoreItem.isExplosive }),
                    ...(selectedStoreItem.units && { units: selectedStoreItem.units }),
                    ...(selectedStoreItem.maxPurchase && { maxPurchase: selectedStoreItem.maxPurchase }),
                    ...(selectedStoreItem.hidingCapacity && { hidingCapacity: selectedStoreItem.hidingCapacity }),
                    ...(selectedStoreItem.inventoryMax && { inventoryMax: selectedStoreItem.inventoryMax }),
                });
            }
            displayInfo(`Bought ${quantity} units of ${selectedStoreItem.name} for $${totalCost.toLocaleString()}.`);
            playSound('buy_item');
            renderShoppingModal();
            updateUI();
            saveGameState();
        };

        shopSellBtn.onclick = async () => {
            console.log("Shop Sell button clicked.");
            if (!selectedPlayerItem) {
                showMessageBox("Please select an item from your inventory to sell.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const itemToSell = selectedPlayerItem;
            const sellPrice = itemToSell.sellPrice; // Use the dedicated sellPrice for items

            sellItemModalTitle.textContent = `Selling Item`;
            sellItemModalMessage.innerHTML = `
                You are selling ${itemToSell.name} for $${sellPrice.toLocaleString()} per unit.<br>
                You have ${itemToSell.qty} units to sell.
            `;
            sellItemQuantityInput.value = itemToSell.qty;
            sellItemQuantityInput.max = itemToSell.qty;
            sellItemModal.style.display = 'flex';

            sellItemModalOkBtn.onclick = null;
            sellItemModalCancelBtn.onclick = null;

            sellItemModalOkBtn.onclick = async () => {
                const quantity = parseInt(sellItemQuantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    sellItemModal.style.display = 'none';
                    await showMessageBox("Please enter a valid quantity to sell.", [{text: 'OK', value: 'ok'}]);
                    shoppingModal.style.display = 'flex';
                    return;
                }
                if (quantity > itemToSell.qty) {
                    sellItemModal.style.display = 'none';
                    await showMessageBox(`You only have ${itemToSell.qty} units of ${itemToSell.name}.`, [{text: 'OK', value: 'ok'}]);
                    shoppingModal.style.display = 'flex';
                    return;
                }

                const totalRevenue = quantity * sellPrice;
                player.cash += totalRevenue;
                itemToSell.qty -= quantity;

                if (itemToSell.qty === 0) {
                    player.items = player.items.filter(item => item.name !== itemToSell.name);
                    selectedPlayerItem = null;
                }

                displayInfo(`Sold ${quantity} units of ${itemToSell.name} for $${totalRevenue.toLocaleString()}.`);
                playSound('buy_item');
                sellItemModal.style.display = 'none';
                shoppingModal.style.display = 'flex';
                updateUI();
                saveGameState();
            };

            sellItemModalCancelBtn.onclick = () => {
                sellItemModal.style.display = 'none';
            };
        };


        // --- Hospital Modal Logic ---
        hospitalBtn.onclick = () => {
            renderHospitalModal();
            hospitalModal.style.display = 'flex';
            playSound('hospital');
        };

        hospitalModalCloseBtn.onclick = () => {
            hospitalModal.style.display = 'none';
            updateUI();
        };

        function renderHospitalModal() {
            hospitalCashDisplay.textContent = `$${player.cash.toLocaleString()}`;
            hospitalCurrentHealth.textContent = player.health;
            healthSlider.value = player.health;
            updateTreatmentCost();
        }

        healthSlider.oninput = () => {
            desiredHealthDisplay.textContent = healthSlider.value;
            updateTreatmentCost();
        };

        function updateTreatmentCost() {
            const desiredHealth = parseInt(healthSlider.value);
            const healthToHeal = desiredHealth - player.health;
            let cost = 0;
            if (healthToHeal > 0) {
                cost = healthToHeal * 30; 
            }
            treatmentCostDisplay.textContent = `$${cost.toLocaleString()}`;
            treatBtn.disabled = cost === 0 || player.cash < cost;
        }

        treatBtn.onclick = async () => {
            const desiredHealth = parseInt(healthSlider.value);
            const healthToHeal = desiredHealth - player.health;
            let cost = healthToHeal * 30;

            if (healthToHeal <= 0) {
                showMessageBox("You don't need healing or are trying to lose health!", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (player.cash < cost) {
                showMessageBox("You don't have enough cash for this treatment!", [{text: 'OK', value: 'ok'}]);
                return;
            }

            player.cash -= cost;
            player.health = desiredHealth;
            displayInfo(`Healed ${healthToHeal} health points for $${cost.toLocaleString()}. Your health is now ${player.health}.`);
            hospitalModal.style.display = 'none';
            updateUI();
            saveGameState();
        };


        // --- Vault Modal Logic ---
        vaultBtn.onclick = () => {
            renderVaultModal();
            vaultModal.style.display = 'flex';
        };

        vaultModalOkBtn.onclick = () => {
            vaultModal.style.display = 'none';
            selectedVaultPocketDrug = null;
            selectedVaultStorageDrug = null;
            updateUI();
        };

        vaultModalCancelBtn.onclick = () => {
            vaultModal.style.display = 'none';
            selectedVaultPocketDrug = null;
            selectedVaultStorageDrug = null;
            updateUI();
        };

        function renderVaultModal() {
            vaultPocketCount.textContent = player.inventory.length;
            vaultPocketLimit.textContent = player.inventoryLimit;
            vaultQuantityInput.value = '';
            renderVaultPocketTable();
            renderVaultStorageTable();
        }

        function renderVaultPocketTable() {
            vaultPocketTableBody.innerHTML = '';
            player.inventory.forEach(item => {
                const row = vaultPocketTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>$${item.purchasePrice.toLocaleString()}</td>
                `;
                row.onclick = () => selectVaultPocketDrug(item.name);
            });
            updateVaultButtons();
        }

        function selectVaultPocketDrug(drugName) {
            selectedVaultPocketDrug = player.inventory.find(item => item.name === drugName);
            Array.from(vaultPocketTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            vaultQuantityInput.value = '';
            updateVaultButtons();
        }

        function renderVaultStorageTable() {
            vaultStorageTableBody.innerHTML = '';
            player.vault.forEach(item => {
                const row = vaultStorageTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>$${item.purchasePrice.toLocaleString()}</td>
                `;
                row.onclick = () => selectVaultStorageDrug(item.name);
            });
            updateVaultButtons();
        }

        function selectVaultStorageDrug(drugName) {
            selectedVaultStorageDrug = player.vault.find(item => item.name === drugName);
            Array.from(vaultStorageTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            vaultQuantityInput.value = '';
            updateVaultButtons();
        }

        intoVaultBtn.onclick = async () => {
            if (!selectedVaultPocketDrug) {
                showMessageBox("Please select a drug from your pocket to move to the vault.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            const quantity = parseInt(vaultQuantityInput.value);
            if (isNaN(quantity) || quantity <= 0) {
                showMessageBox("Please enter a valid quantity.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (quantity > selectedVaultPocketDrug.qty) {
                showMessageBox(`You only have ${selectedVaultPocketDrug.qty} units of ${selectedVaultPocketDrug.name} in your pocket.`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            selectedVaultPocketDrug.qty -= quantity;
            const existingVaultDrugIndex = player.vault.findIndex(item => item.name === selectedVaultPocketDrug.name);
            if (existingVaultDrugIndex !== -1) {
                player.vault[existingVaultDrugIndex].qty += quantity;
            } else {
                player.vault.push({ ...selectedVaultPocketDrug, qty: quantity });
            }

            if (selectedVaultPocketDrug.qty === 0) {
                player.inventory = player.inventory.filter(item => item.name !== selectedVaultPocketDrug.name);
                selectedVaultPocketDrug = null;
            }
            displayInfo(`Moved ${quantity} units of ${selectedVaultPocketDrug?.name || 'drug'} into the vault.`);
            playSound('vault_move');
            renderVaultModal();
            updateUI();
            saveGameState();
        };

        fromVaultBtn.onclick = async () => {
            if (!selectedVaultStorageDrug) {
                showMessageBox("Please select a drug from the vault to move to your pocket.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            const quantity = parseInt(vaultQuantityInput.value);
            if (isNaN(quantity) || quantity <= 0) {
                showMessageBox("Please enter a valid quantity.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (quantity > selectedVaultStorageDrug.qty) {
                showMessageBox(`You only have ${selectedVaultStorageDrug.qty} units of ${selectedVaultStorageDrug.name} in the vault.`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            const existingPocketDrugIndex = player.inventory.findIndex(item => item.name === selectedVaultStorageDrug.name);
            if (existingPocketDrugIndex === -1 && player.inventory.length >= player.inventoryLimit) {
                showMessageBox(`Your pants pocket is full! You can only carry ${player.inventoryLimit} types of drugs.`, [{text: 'OK', value: 'ok'}]);
                return;
            }

            selectedVaultStorageDrug.qty -= quantity;
            if (existingPocketDrugIndex !== -1) {
                player.inventory[existingPocketDrugIndex].qty += quantity;
            } else {
                player.inventory.push({ ...selectedVaultStorageDrug, qty: quantity });
            }

            if (selectedVaultStorageDrug.qty === 0) {
                player.vault = player.vault.filter(item => item.name !== selectedVaultStorageDrug.name);
                selectedVaultStorageDrug = null;
            }
            displayInfo(`Moved ${quantity} units of ${selectedVaultStorageDrug?.name || 'drug'} from the vault to your pocket.`);
            playSound('vault_move');
            renderVaultModal();
            updateUI();
            saveGameState();
        };

        /**
         * Helper function to calculate the distance between two cities.
         * Assumes travelCost is a proxy for distance from a common origin.
         * @param {string} city1Name - Name of the first city.
         * @param {string} city2Name - Name of the second city.
         * @returns {number} - The calculated distance.
         */
        function getDistanceBetweenCities(city1Name, city2Name) {
            const city1 = cities.find(c => c.name === city1Name);
            const city2 = cities.find(c => c.name === city2Name);

            if (!city1 || !city2) {
                console.error("One or both cities not found for distance calculation.");
                return 0;
            }
            return Math.abs(city1.travelCost - city2.travelCost);
        }

        // --- Shipping Modal Logic ---
        shippingBtn.onclick = () => {
            renderShippingModal();
            shippingModal.style.display = 'flex';
        };

        shippingModalCancelBtn.onclick = () => {
            shippingModal.style.display = 'none';
            currentShippingList = [];
            selectedShippingStockDrug = null;
            selectedShippingListDrug = null;
            selectedShippingDestination = null;
            selectedShipper = null;
            updateUI();
        };

        confirmShipBtn.onclick = async () => {
            if (currentShippingList.length === 0) {
                showMessageBox("Please add drugs to your shipping list.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (!selectedShippingDestination) {
                showMessageBox("Please select a destination city.", [{text: 'OK', value: 'ok'}]);
                return;
            }
            if (!selectedShipper) {
                showMessageBox("Please select a shipper.", [{text: 'OK', value: 'ok'}]);
                return;
            }

            const deliveryDays = parseInt(document.querySelector('input[name="delivery-time"]:checked').value);
            const totalCost = calculateShippingCost();

            if (player.cash < totalCost) {
                showMessageBox("You don't have enough cash for this shipment!", [{text: 'OK', value: 'ok'}]);
                return;
            }

            player.cash -= totalCost;

            currentShippingList.forEach(item => {
                player.shipments.push({
                    drugName: item.name,
                    qty: item.qty,
                    destination: selectedShippingDestination.name,
                    arrivalDay: player.day + deliveryDays,
                    purchasePrice: item.purchasePrice
                });
            });

            displayInfo(`Shipped ${currentShippingList.length} types of drugs to ${selectedShippingDestination.name} with ${selectedShipper.name} for $${totalCost.toLocaleString()}. Arrival in ${deliveryDays} days.`);
            shippingModal.style.display = 'none';
            currentShippingList = [];
            selectedShippingStockDrug = null;
            selectedShippingListDrug = null;
            selectedShippingDestination = null;
            selectedShipper = null;
            updateUI();
            saveGameState();
        };

        shipItemBtn.onclick = async () => {
            try {
                if (!selectedShippingStockDrug) {
                    showMessageBox("Please select a drug from your stock to ship.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                const quantity = parseInt(shippingQuantityInput.value);
                if (isNaN(quantity) || quantity <= 0) {
                    showMessageBox("Please enter a valid quantity.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > selectedShippingStockDrug.qty) {
                    showMessageBox(`You only have ${selectedShippingStockDrug.qty} units of ${selectedShippingStockDrug.name} in your stock.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                // Capture properties before potentially modifying selectedShippingStockDrug reference
                const drugToShipName = selectedShippingStockDrug.name;
                const drugToShipPurchasePrice = selectedShippingStockDrug.purchasePrice;
                
                // Remove from player.inventory
                selectedShippingStockDrug.qty -= quantity;
                
                // Add to currentShippingList
                const existingShippingListItemIndex = currentShippingList.findIndex(item => item.name === drugToShipName);
                if (existingShippingListItemIndex !== -1) {
                    currentShippingList[existingShippingListItemIndex].qty += quantity;
                } else {
                    currentShippingList.push({
                        name: drugToShipName,
                        qty: quantity,
                        purchasePrice: drugToShipPurchasePrice
                    });
                }

                // If all of the drug was moved from inventory, clear selectedShippingStockDrug
                if (selectedShippingStockDrug.qty === 0) {
                    player.inventory = player.inventory.filter(item => item.name !== drugToShipName); // Filter by captured name
                    selectedShippingStockDrug = null;
                }

                displayInfo(`Added ${quantity} units of ${drugToShipName} to the shipping list.`);
                renderShippingModal();
                updateUI();
                saveGameState();
            } catch (error) {
                console.error("Error during shipItemBtn.onclick:", error);
                showMessageBox("An error occurred while adding to shipment. Please try again.", [{text: 'OK', value: 'ok'}]);
            }
        };

        dontShipItemBtn.onclick = async () => {
            try {
                if (!selectedShippingListDrug) {
                    showMessageBox("Please select a drug from your shipping list to remove.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                const quantity = parseInt(shippingQuantityInput.value);
                if (isNaN(quantity) || quantity <= 0) {
                    showMessageBox("Please enter a valid quantity.", [{text: 'OK', value: 'ok'}]);
                    return;
                }
                if (quantity > selectedShippingListDrug.qty) {
                    showMessageBox(`You only have ${selectedShippingListDrug.qty} units of ${selectedShippingListDrug.name} in the shipping list.`, [{text: 'OK', value: 'ok'}]);
                    return;
                }

                // Add back to player.inventory
                const existingInventoryDrugIndex = player.inventory.findIndex(item => item.name === selectedShippingListDrug.name);
                if (existingInventoryDrugIndex !== -1) {
                    player.inventory[existingInventoryDrugIndex].qty += quantity;
                } else {
                    player.inventory.push({ ...selectedShippingListDrug, qty: quantity });
                }

                // Remove from currentShippingList
                selectedShippingListDrug.qty -= quantity;
                if (selectedShippingListDrug.qty === 0) {
                    currentShippingList = currentShippingList.filter(item => item.name !== selectedShippingListDrug.name);
                    selectedShippingListDrug = null;
                }

                displayInfo(`Removed ${quantity} units of ${selectedShippingListDrug?.name || 'drug'} from the shipping list.`);
                renderShippingModal();
                updateUI();
                saveGameState();
            } catch (error) {
                console.error("Error during dontShipItemBtn.onclick:", error);
                showMessageBox("An error occurred while removing from shipment. Please try again.", [{text: 'OK', value: 'ok'}]);
            }
        };

        function renderShippingModal() {
            shippingCurrentLocation.textContent = player.location;
            shippingQuantityInput.value = '';
            renderShippingStockTable();
            renderShippingListTable();
            renderShippingDestinationTable();
            renderShippingShipperTable();
            calculateShippingCost();
        }

        function renderShippingStockTable() {
            shippingStockTableBody.innerHTML = '';
            player.inventory.forEach(item => {
                const row = shippingStockTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                `;
                row.onclick = () => selectShippingStockDrug(item.name);
            });
            updateShippingButtons();
        }

        function selectShippingStockDrug(drugName) {
            selectedShippingStockDrug = player.inventory.find(item => item.name === drugName);
            Array.from(shippingStockTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            shippingQuantityInput.value = '';
            updateShippingButtons();
            calculateShippingCost();
        }

        function renderShippingListTable() {
            shippingListTableBody.innerHTML = '';
            currentShippingList.forEach(item => {
                const row = shippingListTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', item.name);
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                `;
                row.onclick = () => selectShippingListDrug(item.name);
            });
            updateShippingButtons();
        }

        function selectShippingListDrug(drugName) {
            selectedShippingListDrug = currentShippingList.find(item => item.name === drugName);
            Array.from(shippingListTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            shippingQuantityInput.value = '';
            updateShippingButtons();
            calculateShippingCost();
        }

        function renderShippingDestinationTable() {
            shippingDestinationTableBody.innerHTML = '';
            cities.filter(city => city.name !== player.location).forEach(city => {
                const row = shippingDestinationTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-city-name', city.name);
                row.innerHTML = `<td>${city.name}</td>`;
                row.onclick = () => selectShippingDestination(city.name);
            });
            updateShippingButtons();
        }

        function selectShippingDestination(cityName) {
            selectedShippingDestination = cities.find(city => city.name === cityName);
            Array.from(shippingDestinationTableBody.rows).forEach(row => {
                if (row.getAttribute('data-city-name') === cityName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            renderShippingShipperTable();
            calculateShippingCost();
            updateShippingButtons();
        }

        function renderShippingShipperTable() {
            shippingShipperTableBody.innerHTML = '';

            const currentSelectedDeliveryDaysValue = document.querySelector('input[name="delivery-time"]:checked')?.value;
            const currentDeliveryRatio = deliveryTimeRatios[currentSelectedDeliveryDaysValue] || 0;

            let totalQuantity = 0;
            if (typeof currentShippingList !== 'undefined' && currentShippingList.length > 0) {
                currentShippingList.forEach(item => {
                    totalQuantity += item.qty;
                });
            }

            let baseDistanceCostForDisplay = 0;
            if (selectedShippingDestination) {
                const distance = getDistanceBetweenCities(player.location, selectedShippingDestination.name);
                baseDistanceCostForDisplay = DISTANCE_COST_FACTOR * distance;
            }

            shippers.forEach(shipper => {
                const row = shippingShipperTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-shipper-name', shipper.name);

                let calculatedShipperCost = 0;
                if (selectedShippingDestination && currentSelectedDeliveryDaysValue) {
                    const costBasedOnDuration = shipper.overnightCost * currentDeliveryRatio;
                    const quantityCost = COST_PER_UNIT_SHIPPED * totalQuantity;
                    calculatedShipperCost = costBasedOnDuration + quantityCost + baseDistanceCostForDisplay;
                } else {
                    calculatedShipperCost = shipper.overnightCost;
                }

                row.innerHTML = `
                    <td>
                        <input type="radio" name="shipper-service" value="${shipper.name}" id="${shipper.name.replace(/\s/g, '-')}-radio" class="form-radio text-blue-600">
                        <label for="${shipper.name.replace(/\s/g, '-')}-radio">${shipper.name}</label>
                    </td>
                    <td>$${Math.round(calculatedShipperCost).toLocaleString()}</td> <td>${shipper.description}</td> `;
                row.onclick = () => selectShipper(shipper.name);

                if (selectedShipper && selectedShipper.name === shipper.name) {
                    const radioInput = row.querySelector(`input[name="shipper-service"]`);
                    if (radioInput) {
                        radioInput.checked = true;
                        row.classList.add('bg-blue-800');
                    }
                }
            });

            updateShippingButtons();
        }

        function selectShipper(shipperName) {
            selectedShipper = shippers.find(shipper => shipper.name === shipperName);
            Array.from(shippingShipperTableBody.rows).forEach(row => {
                if (row.getAttribute('data-shipper-name') === shipperName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });
            calculateShippingCost();
            updateShippingButtons();
        }

        document.querySelectorAll('input[name="delivery-time"]').forEach(radio => {
            radio.addEventListener('change', () => {
                renderShippingShipperTable();
                calculateShippingCost();
            });
        });

        function calculateShippingCost() {
            let cost = 0;
            if (selectedShipper && selectedShippingDestination) {
                const deliveryDays = document.querySelector('input[name="delivery-time"]:checked').value;
                
                let totalQuantity = 0;
                currentShippingList.forEach(item => {
                    totalQuantity += item.qty;
                });

                const distance = getDistanceBetweenCities(player.location, selectedShippingDestination.name);

                const baseShipperCostForSelectedTime = selectedShipper.overnightCost * deliveryTimeRatios[deliveryDays];
                
                const quantityCost = COST_PER_UNIT_SHIPPED * totalQuantity;
                const distanceCost = DISTANCE_COST_FACTOR * distance;
                
                cost = baseShipperCostForSelectedTime + quantityCost + distanceCost;
            }
            shippingTotalCostDisplay.textContent = `$${Math.round(cost).toLocaleString()}`;
            return Math.round(cost);
        }

        // Add this new function for updating shipping buttons
        function updateShippingButtons() {
            shipItemBtn.disabled = !selectedShippingStockDrug || shippingQuantityInput.value <= 0;
            dontShipItemBtn.disabled = !selectedShippingListDrug || shippingQuantityInput.value <= 0;
            confirmShipBtn.disabled = currentShippingList.length === 0 || !selectedShippingDestination || !selectedShipper;
        }

        // --- New Info Modals Logic ---
        infoBtn.onclick = () => {
            infoOptionsModal.style.display = 'flex';
        };

        infoOptionsModalCloseBtn.onclick = () => {
            infoOptionsModal.style.display = 'none';
        };

        viewWorldPricesBtn.onclick = () => {
            infoOptionsModal.style.display = 'none';
            renderWorldPricesQuantitiesModal();
            worldPricesQuantitiesModal.style.display = 'flex';
        };

        worldPricesQuantitiesModalCloseBtn.onclick = () => {
            worldPricesQuantitiesModal.style.display = 'none';
            selectedWorldPricesDrug = null;
        };

        /**
         * Renders the World Prices and Quantities modal, displaying drug names and then city-specific prices/quantities.
         * The structure already matches the screenshot with two distinct panels side-by-side.
         */
        function renderWorldPricesQuantitiesModal() {
            worldPricesDrugTableBody.innerHTML = '';
            drugs.forEach(drug => {
                const row = worldPricesDrugTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-drug-name', drug.name);
                row.innerHTML = `<td>${drug.name}</td>`;
                row.onclick = () => selectDrugForWorldPrices(drug.name);
            });
            worldPricesCityListTableBody.innerHTML = '';
            selectedWorldPricesDrug = null;
        }

        function selectDrugForWorldPrices(drugName) {
            selectedWorldPricesDrug = drugs.find(drug => drug.name === drugName);

            Array.from(worldPricesDrugTableBody.rows).forEach(row => {
                if (row.getAttribute('data-drug-name') === drugName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });

            worldPricesCityListTableBody.innerHTML = '';
            cities.forEach(city => {
                const price = generatePrice(selectedWorldPricesDrug.basePrice, city.name, selectedWorldPricesDrug.name);
                const qty = generateQuantity(); // Use generateQuantity here too
                const row = worldPricesCityListTableBody.insertRow();
                row.innerHTML = `
                    <td>${city.name}</td>
                    <td>${qty}</td>
                    <td>$${price.toLocaleString()}</td>
                `;
            });
        }

        viewWorldCitiesBtn.onclick = () => {
            infoOptionsModal.style.display = 'none';
            renderWorldCitiesModal();
            worldCitiesModal.style.display = 'flex';
        };

        worldCitiesModalCloseBtn.onclick = () => {
            worldCitiesModal.style.display = 'none';
            selectedWorldCitiesCity = null;
        };

        /**
         * Renders the World Cities modal, displaying city names and then drug-specific prices/quantities.
         * The structure already matches the screenshot with two distinct panels side-by-side.
         */
        function renderWorldCitiesModal() {
            worldCitiesCityTableBody.innerHTML = '';
            cities.forEach(city => {
                const row = worldCitiesCityTableBody.insertRow();
                row.classList.add('cursor-pointer', 'hover:bg-gray-700');
                row.setAttribute('data-city-name', city.name);
                row.innerHTML = `<td>${city.name}</td>`;
                row.onclick = () => selectCityForWorldPrices(city.name);
            });
            worldCitiesDrugListTableBody.innerHTML = '';
            selectedWorldCitiesCity = null;
        }

        function selectCityForWorldPrices(cityName) {
            selectedWorldCitiesCity = cities.find(city => city.name === cityName);

            Array.from(worldCitiesCityTableBody.rows).forEach(row => {
                if (row.getAttribute('data-city-name') === cityName) {
                    row.classList.add('bg-blue-800');
                } else {
                    row.classList.remove('bg-blue-800');
                }
            });

            drugs.forEach(drug => {
                const price = generatePrice(drug.basePrice, selectedWorldCitiesCity.name, drug.name);
                const qty = generateQuantity(); // Use generateQuantity here too
                const row = worldCitiesDrugListTableBody.insertRow();
                row.innerHTML = `
                    <td>${drug.name}</td>
                    <td>${qty}</td>
                    <td>$${price.toLocaleString()}</td>
                `;
            });
        }

        // --- Shipment Status Modal Logic ---
        shipmentStatusBtn.onclick = () => {
            renderShipmentStatusModal();
            shipmentStatusModal.style.display = 'flex';
        };

        shipmentStatusModalCloseBtn.onclick = () => {
            shipmentStatusModal.style.display = 'none';
        };

        function renderShipmentStatusModal() {
            shipmentStatusTableBody.innerHTML = '';
            if (player.shipments.length === 0) {
                const row = shipmentStatusTableBody.insertRow();
                row.innerHTML = `<td colspan="4" class="text-center py-4">No active shipments.</td>`;
                return;
            }

            player.shipments.forEach(shipment => {
                const row = shipmentStatusTableBody.insertRow();
                const daysRemaining = shipment.arrivalDay - player.day;
                let arrivalText = '';
                let statusText = '';

                if (daysRemaining <= 0) {
                    arrivalText = 'Arrived';
                    statusText = 'Delivered';
                } else if (daysRemaining === 1) {
                    arrivalText = '1 day';
                    statusText = 'In Transit';
                } else {
                    arrivalText = `${daysRemaining} days`;
                    statusText = 'In Transit';
                }

                row.innerHTML = `
                    <td>${player.location}</td>
                    <td>${shipment.destination}</td>
                    <td>${arrivalText}</td> <!-- Display days remaining or 'Arrived' -->
                    <td>${statusText}</td>
                `;
            });
        }


        /**
         * Updates all UI elements.
         */
        function updateUI() {
            renderMarketTable();
            renderInventoryTable();
            updateStatus();
            updateTradeButtons();
            updateTravelButton();
            if (financesModal.style.display === 'flex') renderFinancesModal();
            if (shoppingModal.style.display === 'flex') renderShoppingModal();
            if (hospitalModal.style.display === 'flex') renderHospitalModal();
            if (vaultModal.style.display === 'flex') renderVaultModal();
            if (shippingModal.style.display === 'flex') renderShippingModal();
            if (sellDrugModal.style.display === 'flex') {
                if (selectedInventoryDrug && marketPrices[selectedInventoryDrug.name]) {
                    const currentMarketPrice = marketPrices[selectedInventoryDrug.name].price;
                    const profitPerUnit = currentMarketPrice - selectedInventoryDrug.purchasePrice;
                    const profitLossText = profitPerUnit >= 0 ? `profit of $${profitPerUnit.toLocaleString()}` : `loss of $${Math.abs(profitPerUnit).toLocaleString()}`;
                    sellDrugModalTitle.textContent = `Selling ${selectedInventoryDrug.name}`;
                    sellDrugModalMessage.innerHTML = `
                        ${selectedInventoryDrug.name} is currently being bought for $${currentMarketPrice.toLocaleString()} per unit.<br>
                        You have ${selectedInventoryDrug.qty} units to sell for a ${profitLossText} per unit.
                    `;
                    sellDrugQuantityInput.value = Math.min(parseInt(sellDrugQuantityInput.value || 0), selectedInventoryDrug.qty);
                    sellDrugQuantityInput.max = selectedInventoryDrug.qty;
                } else {
                    sellDrugModal.style.display = 'none';
                }
            }
            if (buyDrugModal.style.display === 'flex') {
                if (selectedMarketDrug) {
                    const currentMarketPrice = selectedMarketDrug.price;
                    const maxAffordableQuantity = Math.floor(player.cash / currentMarketPrice);
                    const maxAvailableQuantity = selectedMarketDrug.qty;
                    const maxBuyQuantity = Math.min(maxAffordableQuantity, maxAvailableQuantity);

                    buyDrugModalTitle.textContent = `Buying ${selectedMarketDrug.name}`;
                    buyDrugModalMessage.innerHTML = `
                        ${selectedMarketDrug.name} is currently selling for $${currentMarketPrice.toLocaleString()} per unit.<br>
                        With your available funds, you can buy ${maxBuyQuantity} units.
                    `;
                    buyDrugQuantityInput.value = Math.min(parseInt(buyDrugQuantityInput.value || 0), maxBuyQuantity);
                    buyDrugQuantityInput.max = maxBuyQuantity;
                } else {
                    buyDrugModal.style.display = 'none';
                }
            }
            if (dumpDrugModal.style.display === 'flex') {
                if (selectedInventoryDrug) {
                    dumpDrugModalTitle.textContent = `Dumping ${selectedInventoryDrug.name}`;
                    dumpDrugModalMessage.innerHTML = `You have ${selectedInventoryDrug.qty} units of ${selectedInventoryDrug.name}.`;
                    dumpDrugQuantityInput.value = Math.min(parseInt(dumpDrugQuantityInput.value || 0), selectedInventoryDrug.qty);
                    dumpDrugQuantityInput.max = selectedInventoryDrug.qty;
                } else {
                    dumpDrugModal.style.display = 'none';
                }
            }
            if (shipmentStatusModal.style.display === 'flex') {
                renderShipmentStatusModal();
            }
            if (airportSecurityModal.style.display === 'flex') {
                updateAirportSecurityUI();
            }
            if (sellItemModal.style.display === 'flex') {
                if (selectedPlayerItem) {
                    const sellPrice = selectedPlayerItem.sellPrice; // Use the dedicated sellPrice for items
                    sellItemModalTitle.textContent = `Selling Item`;
                    sellItemModalMessage.innerHTML = `
                        You are selling ${selectedPlayerItem.name} for $${sellPrice.toLocaleString()} per unit.<br>
                        You have ${selectedPlayerItem.qty} units to sell.
                    `;
                    sellItemQuantityInput.value = Math.min(parseInt(sellItemQuantityInput.value || 0), selectedPlayerItem.qty);
                    sellItemQuantityInput.max = selectedPlayerItem.qty;
                } else {
                    sellItemModal.style.display = 'none';
                }
            }
            if (buyItemQuantityModal.style.display === 'flex') {
                if (selectedStoreItem) {
                    buyItemQuantityModalTitle.textContent = `Buying ${selectedStoreItem.name}`;
                    buyItemQuantityModalMessage.innerHTML = `
                        ${selectedStoreItem.name} is currently selling for $${selectedStoreItem.price.toLocaleString()} per unit.<br>
                        Your Cash: $${player.cash.toLocaleString()}
                    `;
                    const maxAffordable = Math.floor(player.cash / selectedStoreItem.price);
                    let currentMax = buyItemQuantityInput.max;

                    if (selectedStoreItem.name === 'Can of No-Scent') {
                        const existingNoScent = player.items.find(item => item.name === 'Can of No-Scent');
                        const currentCans = existingNoScent ? existingNoScent.qty : 0;
                        const maxAllowed = selectedStoreItem.inventoryMax - currentCans;
                        currentMax = Math.min(selectedStoreItem.maxPurchase, maxAllowed, maxAffordable);
                        if (maxAllowed <= 0) {
                            buyItemQuantityModalMessage.innerHTML += `<br><span class="text-red-400">You cannot carry any more ${selectedStoreItem.name}.</span>`;
                            currentMax = 0;
                        }
                    } else if (selectedStoreItem.type !== 'Ammo') {
                        currentMax = Math.min(currentMax, maxAffordable);
                    }
                    buyItemQuantityInput.max = currentMax;
                    buyItemQuantityInput.value = Math.min(parseInt(buyItemQuantityInput.value || 0), currentMax);
                } else {
                    buyItemQuantityModal.style.display = 'none';
                }
            }
             if (borrowAmountModal.style.display === 'flex') {
                if (selectedLoan) {
                    borrowAmountModalTitle.textContent = `Borrow from ${selectedLoan.name}`;
                    borrowAmountModalMessage.innerHTML = `
                        ${selectedLoan.name} is offering a maximum loan of $${selectedLoan.maxLoan.toLocaleString()} at a rate of ${(selectedLoan.rate * 100).toFixed(1)}%.
                        <br>
                        How much do you wish to borrow?
                    `;
                    borrowInputField.max = selectedLoan.maxLoan;
                    borrowInputField.value = Math.min(parseInt(borrowInputField.value || 0), selectedLoan.maxLoan);
                } else {
                    borrowAmountModal.style.display = 'none';
                }
            }
        }

        /**
         * Sets the UI state when no game is active (e.g., on initial load or after game over).
         * Disables main game action buttons until a new game is started.
         */
        function updateUIForNoGame() {
            // Disable primary game action buttons
            buyBtn.disabled = true;
            sellBtn.disabled = true;
            dumpBtn.disabled = true;
            financesBtn.disabled = true;
            shoppingBtn.disabled = true;
            hospitalBtn.disabled = true;
            vaultBtn.disabled = true;
            shippingBtn.disabled = true;
            shipmentStatusBtn.disabled = true;
            stayHereBtn.disabled = true;
            flyAwayBtn.disabled = true;
            tradeQuantityInput.disabled = true;

            // Clear dynamic tables
            // Check if marketTableBody is not null before setting innerHTML
            if (marketTableBody) {
                marketTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Click "New Game" to start.</td></tr>';
            }
            // Check if inventoryTableBody is not null before setting innerHTML
            if (inventoryTableBody) {
                inventoryTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400">Your pocket is empty.</td></tr>';
            }

            // Reset status display
            player.cash = 0; player.bank = 0; player.debt = 0;
            player.health = 100; player.day = 0; player.location = 'N/A';
            updateStatus(); // This will display the N/A and 0s
            statusRank.textContent = 'Unranked'; // Set an appropriate rank for pre-game

            // Ensure New Game button is enabled
            newGameBtn.disabled = false;
        }

        /**
         * Enables all game action buttons.
         */
        function enableGameUIButtons() {
            buyBtn.disabled = false;
            sellBtn.disabled = false;
            dumpBtn.disabled = false;
            financesBtn.disabled = false;
            shoppingBtn.disabled = false;
            hospitalBtn.disabled = false;
            vaultBtn.disabled = false;
            shippingBtn.disabled = false;
            shipmentStatusBtn.disabled = false;
            stayHereBtn.disabled = false;
            flyAwayBtn.disabled = false;
            tradeQuantityInput.disabled = false;
            newGameBtn.disabled = false; // Keep new game enabled
        }


        /**
         * Makes a modal draggable by its title bar.
         * @param {HTMLElement} modalElement - The modal element to make draggable.
         * @param {HTMLElement} handleElement - The element that acts as the drag handle (e.g., the title bar).
         */
        function makeDraggable(modalElement, handleElement) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            handleElement.addEventListener("mousedown", dragStart);
            handleElement.addEventListener("touchstart", dragStart, { passive: false });

            function dragStart(e) {
                e.preventDefault();
                const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;

                initialX = clientX - xOffset;
                initialY = clientY - yOffset;

                modalElement.style.position = 'fixed';
                modalElement.style.transform = 'none';

                isDragging = true;

                document.addEventListener("mousemove", drag);
                document.addEventListener("mouseup", dragEnd);
                document.addEventListener("touchmove", drag, { passive: false });
                document.addEventListener("touchend", dragEnd);
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
                    const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;

                    currentX = clientX - initialX;
                    currentY = clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    modalElement.style.left = `${currentX}px`;
                    modalElement.style.top = `${currentY}px`;
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                document.removeEventListener("mousemove", drag);
                document.removeEventListener("mouseup", dragEnd);
                document.removeEventListener("touchmove", drag);
                document.removeEventListener("touchend", dragEnd);
            }
        }

        // Initialize game on window load
        window.onload = function() {
            updateUIForNoGame(); // Set initial UI to "no game active" state
            initializeFirebase(); 

            // Make modals draggable
            allModals.forEach(modalElement => {
                if (modalElement) { // Ensure modal element exists
                    const handleElement = modalElement.querySelector('.panel-title');
                    if (handleElement) {
                        makeDraggable(modalElement, handleElement);
                    } else {
                        console.warn(`Could not find .panel-title handle for modal ID: ${modalElement.id}`);
                    }
                }
            });

            // Add event listeners for the new close buttons
            document.querySelectorAll('.close-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const modalId = event.target.dataset.modalId;
                    const modalToClose = document.getElementById(modalId);
                    if (modalToClose) {
                        modalToClose.style.display = 'none';
                        enableGameUI(); // Re-enable game UI when a modal is closed
                        // Specific cleanup for certain modals if needed
                        if (modalId === 'places-modal') {
                            selectedTravelCity = null;
                        } else if (modalId === 'finances-modal') {
                            selectedLoan = null;
                        } else if (modalId === 'shopping-modal') {
                            selectedStoreItem = null;
                            selectedPlayerItem = null;
                        } else if (modalId === 'vault-modal') {
                            selectedVaultPocketDrug = null;
                            selectedVaultStorageDrug = null;
                        } else if (modalId === 'shipping-modal') {
                            currentShippingList = [];
                            selectedShippingStockDrug = null;
                            selectedShippingListDrug = null;
                            selectedShippingDestination = null;
                            selectedShipper = null;
                        } else if (modalId === 'sell-drug-modal' || modalId === 'buy-drug-modal' || modalId === 'dump-drug-modal') {
                            // These modals are generally closed by their own OK/Cancel buttons,
                            // but having an X button is good for consistency. No specific state to reset here.
                        } else if (modalId === 'info-options-modal' || modalId === 'world-prices-quantities-modal' || modalId === 'world-cities-modal' || modalId === 'shipment-status-modal' || modalId === 'using-no-scent-modal' || modalId === 'sell-item-modal' || modalId === 'buy-item-quantity-modal' || modalId === 'borrow-amount-modal') {
                            // No specific state to reset for these informational/intermediate modals on X close
                        } else if (modalId === 'airport-security-modal') {
                            // If closed via X, consider it a "run away" or "cancel"
                            if (pendingTravelCity) {
                                showMessageBox("Travel to previous destination cancelled.", [{text: 'OK', value: 'ok'}]);
                                pendingTravelCity = null;
                            }
                            placesModal.style.display = 'none'; // Ensure places modal is also closed
                        }
                        updateUI(); // Re-render UI to reflect any changes
                    }
                });
            });
        };
    </script>
</body>
</html>
